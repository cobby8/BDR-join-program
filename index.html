<!-- filename: join.html (또는 index.html 교체) -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BDR 참가신청서</title>
  <style>
    :root{
      --brand:#1966ff; --text:#0f172a; --muted:#64748b; --bg:#f6f8fb;
      --border:#e5e7eb; --ok:#16a34a; --warn:#d97706; --bad:#ef4444; --card:#fff;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,'Noto Sans KR',sans-serif}
    .wrap{max-width:980px;margin:28px auto;padding:24px;background:#fff;border-radius:24px;
      box-shadow:0 10px 30px rgba(0,0,0,.05)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    h1{font-size:28px;margin:0 0 8px}
    .steps{color:var(--muted);font-size:14px;margin-bottom:22px}
    .section-title{font-weight:800;font-size:22px;margin:22px 0 8px}
    label{display:block;font-weight:700;margin:14px 0 8px}
    select,input,button{width:100%;font-size:16px;padding:16px;border:1px solid var(--border);
      border-radius:12px;background:#fff}
    select:focus,input:focus{outline:3px solid rgba(25,102,255,.2);border-color:var(--brand)}
    .help{color:var(--muted);font-size:14px;margin-top:10px}
    .note{display:flex;gap:8px;align-items:flex-start;color:#334155;background:#f1f5f9;
      border:1px dashed #cbd5e1;padding:12px;border-radius:12px;margin-top:12px}
    .row{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:720px){ .row-2{grid-template-columns:1fr 1fr}}
    .btn-primary{background:var(--brand);color:#fff;border:none;font-weight:700}
    .btns{display:flex;gap:12px;justify-content:flex-end;margin-top:18px}
    .hidden{display:none!important}

    /* 카드 */
    .card{background:var(--card);border:1px solid var(--border);
      border-radius:var(--radius);padding:16px}
    .card h3{margin:0 0 10px;font-size:18px}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:8px;font-size:15px}
    .chip{display:inline-flex;align-items:center;gap:8px;font-weight:700;
      padding:6px 12px;border-radius:999px;border:1px solid var(--border);font-size:13px}
    .chip.ok{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
    .chip.warn{border-color:#fde68a;background:#fffbeb;color:#92400e}
    .chip.bad{border-color:#fecaca;background:#fef2f2;color:#991b1b}
    a.link{color:var(--brand);font-weight:700;text-decoration:none}
    a.link:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>BDR 참가신청서</h1>
        <div class="steps">참가 대회 선택 → 팀 대표 정보 → 선수 명단 → 제출</div>
      </div>
      <img src="https://raw.githubusercontent.com/cobby8/assets/main/bdr-logo.png"
           alt="BDR" style="height:36px"/>
    </header>

    <!-- STEP 0: 대회 선택 -->
    <section id="step0">
      <div class="section-title">0) 참가희망 대회</div>

      <label for="selTournament">대회 선택</label>
      <select id="selTournament" aria-label="대회 선택">
        <option value="">대회를 선택하세요</option>
      </select>

      <p class="help">※ 대회를 선택하면 해당 대회 정보가 아래에 표시되고, ‘다음’ 버튼이 활성화됩니다.</p>

      <!-- 동적 정보 카드 -->
      <div id="tourInfo" class="card hidden" aria-live="polite"></div>

      <div class="btns">
        <button id="btnNext0" class="btn-primary hidden">다음 →</button>
      </div>
    </section>

    <!-- STEP 1: 대표 정보 (요구사항 2 반영: 연락처 보조문구 & 숫자만 입력) -->
    <section id="step1" class="hidden">
      <div class="section-title">1) 팀 대표 정보</div>
      <div class="row row-2">
        <div>
          <label for="leaderName">대표자 이름</label>
          <input id="leaderName" placeholder="예) 김수빈" autocomplete="name" />
        </div>
        <div>
          <label for="leaderPhone">대표자 연락처</label>
          <input id="leaderPhone" inputmode="numeric" pattern="[0-9]*" maxlength="11"
                 placeholder="숫자만 입력(하이픈 없이)" aria-describedby="phoneHelp" />
          <div id="phoneHelp" class="help">숫자만 입력(하이픈 없이). 예) 01012345678</div>
        </div>
      </div>

      <div class="btns">
        <button id="btnPrev1" class="btn-line">← 이전</button>
        <button id="btnNext1" class="btn-primary">다음 →</button>
      </div>
    </section>

    <!-- STEP 2 이후는 기존 페이지 그대로 이어 붙이면 됩니다 -->
  </div>

  <script>
    /* ====== 설정: 본인의 GAS Web App URL(…/exec) 로 교체 ====== */
    const API_BASE = "https://SCRIPT-ID-REPLACE.exec"; // ← 여기를 본인 것으로 교체

    /* ====== 유틸 ====== */
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function safeJSON(v, fb){ try{ return JSON.parse(v);}catch{ return fb; } }
    function toDate(s){
      if(!s) return null;
      const d = new Date(s);
      if(!isNaN(d)) return d;
      // 'yyyy-MM-dd' 같은 순수 날짜도 대응
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00');
      return null;
    }
    const fmt = (d, withTime=false)=>{
      if(!d) return '';
      const o = withTime
        ? {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}
        : {year:'numeric',month:'2-digit',day:'2-digit'};
      return d.toLocaleString('ko-KR', o).replaceAll('. ','-').replace('.','').replace(/\.$/,'');
    };
    const statusChip = s=>{
      const txt = String(s||'').trim();
      const map = { '접수중':'ok', '마감':'bad', '접수전':'warn' };
      const cls = map[txt] || '';
      return `<span class="chip ${cls}">${txt||'상태 미정'}</span>`;
    };

    /* ====== 상태 관리 ====== */
    let TOURNAMENTS = [];
    let SELECTED = null;

    /* ====== 초기 로드: 대회 목록 ====== */
    async function loadTournaments(){
      const url = API_BASE + "?path=tournaments";
      const res = await fetch(url);
      if(!res.ok) throw new Error("대회 목록을 불러올 수 없습니다.");
      const json = await res.json();
      if(!json.ok) throw new Error(json.error || "오류가 발생했습니다.");
      TOURNAMENTS = json.rows || [];
      fillSelect(TOURNAMENTS);
    }

    function fillSelect(rows){
      const sel = $('#selTournament');
      // 최신 생성 순 정렬은 백엔드에서 해주지만, 안전하게 이름 기준 보조정렬
      rows.sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||'') || a.name.localeCompare(b.name));
      rows.forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r.tourId || r.TourID || '';
        const s = toDate(r.start), e = toDate(r.end);
        const span = (s&&e) ? ` (${fmt(s)} ~ ${fmt(e)})` : '';
        opt.textContent = `${r.name||'(이름없음)'}${span}`;
        sel.appendChild(opt);
      });
    }

    /* ====== 선택 시 카드 렌더 & 버튼 ON ====== */
    function renderInfoCard(t){
      if(!t){ $('#tourInfo').classList.add('hidden'); $('#btnNext0').classList.add('hidden'); return; }
      const places = Array.isArray(t.places) ? t.places
        : safeJSON(t.places||'[]', []).map(p=>typeof p==='string'?{name:p}:p);
      const placeText = (places||[]).map(p=>p && (p.name||'')).filter(Boolean).join(' · ') || '미정';

      const s = toDate(t.start), e = toDate(t.end);
      const rs = toDate(t.regStart), re = toDate(t.regEnd);

      $('#tourInfo').innerHTML = `
        <h3>${t.name||''}</h3>
        <div class="kv">
          <div>대회 기간</div><div>${s?fmt(s):'미정'} ~ ${e?fmt(e):'미정'}</div>
          <div>접수 기간</div><div>${rs?fmt(rs,true):'미정'} ~ ${re?fmt(re,true):'미정'}</div>
          <div>장소</div><div>${placeText}</div>
          <div>상태</div><div>${statusChip(t.status)}</div>
          <div>안내 페이지</div><div>${t.url?`<a class="link" href="${t.url}" target="_blank" rel="noopener">열기</a>`:'-'} </div>
        </div>
        <div class="note" style="margin-top:12px">
          <div>※</div>
          <div>선택한 대회에 설정된 종별/디비전만 다음 단계에서 선택할 수 있습니다.</div>
        </div>
      `;
      $('#tourInfo').classList.remove('hidden');
      $('#btnNext0').classList.remove('hidden');
    }

    /* ====== 전화번호: 숫자만 유지 ====== */
    function enforceDigits(el){
      const only = (el.value||'').replace(/\D+/g,'');
      if(el.value !== only) el.value = only;
    }

    /* ====== 이벤트 바인딩 ====== */
    function bind(){
      // 대회 선택
      $('#selTournament').addEventListener('change', e=>{
        const id = e.target.value || '';
        SELECTED = TOURNAMENTS.find(r=>(r.tourId||r.TourID)===id) || null;
        renderInfoCard(SELECTED);
      });

      // 다음(0→1)
      $('#btnNext0').addEventListener('click', ()=>{
        if(!SELECTED){ alert('대회를 선택해주세요.'); return; }
        // 필요 시 다음 단계에서 사용하도록 보관
        sessionStorage.setItem('bdr.selected.tournament', JSON.stringify(SELECTED));
        $('#step0').classList.add('hidden');
        $('#step1').classList.remove('hidden');
        // 모바일에서 바로 입력할 수 있게 포커스
        setTimeout(()=>$('#leaderName').focus(), 0);
      });

      // 이전(1→0)
      $('#btnPrev1').addEventListener('click', ()=>{
        $('#step1').classList.add('hidden');
        $('#step0').classList.remove('hidden');
      });

      // 연락처 - 숫자만
      const phone = $('#leaderPhone');
      ['input','blur','paste'].forEach(evt=> phone.addEventListener(evt, ()=>enforceDigits(phone)));
    }

    /* ====== 시작 ====== */
    (async function init(){
      try{
        bind();
        await loadTournaments();
      }catch(err){
        console.error(err);
        alert('대회 목록을 불러오지 못했습니다. API 주소(API_BASE)를 확인해주세요.');
      }
    })();
  </script>
</body>
</html>
