<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR 참가신청서</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f8fbfd; --card:#fff; --shadow:0 8px 32px #1769ff1a; --radius:18px; --red:#ef4444; --muted:#6b7684 }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:980px;margin:28px auto;padding:16px}
  .card{background:var(--card);border-radius:24px;box-shadow:var(--shadow);padding:24px;position:relative}
  h1{font-size:28px;margin:0 0 10px}
  .section-title{font-weight:800;margin:18px 0 8px}
  label{display:block;font-weight:700;margin:14px 0 6px}
  input,select,textarea{width:100%;padding:14px 12px;border:1px solid #e6ecf5;border-radius:14px;font-size:16px;outline:none;background:#fff}
  input:focus,select:focus,textarea:focus{border-color:var(--blue)}
  .row{display:grid;gap:12px}
  @media(min-width:720px){ .row-2{grid-template-columns:1fr 1fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  .muted{color:var(--muted);font-size:13px;margin-top:6px}
  .btn{margin-top:18px;width:100%;padding:14px;border:none;border-radius:14px;background:var(--blue);color:#fff;font-weight:700;font-size:17px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.done{background:#2ebf6f}
  .btn-sm{padding:8px 12px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer;margin-top:10px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#222;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s;z-index:3}
  .toast.show{opacity:1}

  .brand{position:absolute;right:30px;top:30px}
  .brand img{height:31px;opacity:.95} /* 30% 확대 */

  .step{display:none}.step.active{display:block}
  .nextbar{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
  .next{padding:10px 14px;border:1px solid #dfe6ee;background:#fff;border-radius:12px;cursor:pointer}
  .next.primary{background:var(--blue);color:#fff;border-color:var(--blue)}
  .error{border-color:var(--red)!important;background:#fff7f7}
  .error-note{color:var(--red);font-size:12px;margin-top:6px}

  #tourInfo.cardish{border:1px solid #e6ecf5;border-radius:14px;padding:12px;background:#fbfdff}
  #tourInfo .kv{display:grid;grid-template-columns:92px 1fr;gap:6px 10px;font-size:14px}
  #tourInfo .kv b{color:#111}

  .color-grid{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
  .color-btn{padding:10px 14px;border:1px solid #cdd6e1;border-radius:12px;background:#fff;cursor:pointer;font-weight:700}
  .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .uniform-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
  .jersey-card{border:1px solid #e6ecf5;border-radius:14px;padding:12px;background:#f7fbff}
  .jersey-title{font-weight:700;margin-bottom:6px}
  .jersey{width:100%;height:180px}

  /* 본인인증 패널 */
  .edit-panel{margin-top:14px;border:1px dashed #dbe5f3;background:#f7fbff;border-radius:14px;padding:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="brand">
      <img id="bdrLogo" alt="BDR" src="BDR(배경없음).png">
    </div>
    <h1>BDR 참가신청서</h1>
    <div class="muted">참가 대회 선택 ➜ 팀 대표 정보 ➜ 선수 명단 ➜ 제출</div>

    <!-- 0) 대회 선택 -->
    <div class="step active" id="step0">
      <div class="section-title">0) 참가희망 대회</div>
      <label>대회 선택</label>
      <select id="tourSelect"><option value="">대회를 선택하세요</option></select>
      <div id="tourInfo" class="muted cardish" style="display:none;margin-top:8px"></div>
      <div class="muted">※ 대회를 선택하면 해당 대회에 설정된 <b>종별/디비전</b>만 선택할 수 있게 자동 제한돼요.</div>

      <!-- 신청서 수정(본인인증) -->
      <div class="edit-panel">
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:end">
          <div style="flex:1;min-width:220px">
            <label>신청자 이름</label>
            <input id="ownerName" placeholder="예: 홍길동">
          </div>
          <div style="flex:1;min-width:220px">
            <label>신청자 연락처</label>
            <input id="ownerPhone" placeholder="숫자만 입력" inputmode="numeric" maxlength="11">
          </div>
          <div>
            <button class="btn-sm" id="ownerFindBtn" type="button">신청서 찾기</button>
          </div>
        </div>
        <div id="ownerResult" style="display:none;margin-top:8px">
          <label>내 신청서 선택</label>
          <select id="ownerTeamSel"></select>
          <div class="nextbar" style="justify-content:flex-start">
            <button class="btn-sm" id="ownerLoadBtn" type="button">불러오기</button>
          </div>
        </div>
        <div class="muted">※ 이름+전화번호로 본인 인증 후 기존 신청서를 불러와 수정할 수 있어요.</div>
      </div>

      <div class="nextbar" id="nextbar0" style="display:none">
        <button class="next primary" data-next="#step1" data-validate="1">다음 →</button>
      </div>
    </div>

    <!-- 1) 팀 기본정보 -->
    <div class="step" id="step1">
      <div class="section-title">① 팀 기본정보</div>

      <div class="row row-2">
        <div>
          <label>시도 선택</label>
          <select id="province"><option value="">선택</option>
            <option>서울특별시</option><option>부산광역시</option><option>대구광역시</option>
            <option>인천광역시</option><option>광주광역시</option><option>대전광역시</option>
            <option>울산광역시</option><option>세종특별자치시</option><option>경기도</option>
            <option>강원특별자치도</option><option>충청북도</option><option>충청남도</option>
            <option>전북특별자치도</option><option>전라남도</option><option>경상북도</option>
            <option>경상남도</option><option>제주특별자치도</option>
          </select>
          <div class="error-note" id="errProvince" style="display:none">시도를 선택해주세요</div>
        </div>
        <div>
          <label>시군구 선택</label>
          <select id="city" disabled><option value="">시도를 먼저 선택하세요</option></select>
          <div class="error-note" id="errCity" style="display:none">시군구를 선택해주세요</div>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label>팀명(한글)</label>
          <input id="teamNameKo" placeholder="예: 슬로우" />
          <div class="error-note" id="errTeamNameKo" style="display:none">팀명(한글)을 입력해주세요</div>
        </div>
        <div>
          <label>팀명(영문)</label>
          <input id="teamNameEn" placeholder="예: SLOW" />
          <div class="error-note" id="errTeamNameEn" style="display:none">팀명(영문)을 입력해주세요</div>
        </div>
      </div>

      <div class="row row-2">
        <div>
          <label>대표자 이름</label>
          <input id="managerName" placeholder="이름" />
          <div class="error-note" id="errManagerName" style="display:none">대표자 이름을 입력해주세요</div>
        </div>
        <div>
          <label>대표자 연락처</label>
          <input id="managerPhone" placeholder="숫자만 입력(하이픈 없이)" inputmode="numeric" pattern="[0-9]*" maxlength="11" autocomplete="tel" />
          <div class="error-note" id="errPhone" style="display:none">숫자만 입력(예: 01012345678)</div>
        </div>
      </div>

      <div class="nextbar">
        <button class="next" data-next="#step0" data-dir="prev">← 이전</button>
        <button class="next primary" data-next="#step2" data-validate="1">다음 →</button>
      </div>
    </div>

    <!-- 2) 종별/디비전 -->
    <div class="step" id="step2">
      <div class="section-title">② 종별/디비전</div>
      <div class="row row-2">
        <div>
          <label>종별</label>
          <select id="category" disabled><option value="">대회를 먼저 선택하세요</option></select>
          <div class="error-note" id="errCategory" style="display:none">종별을 선택해주세요</div>
        </div>
        <div>
          <label>디비전</label>
          <select id="division" disabled><option value="">종별을 먼저 선택하세요</option></select>
          <div class="error-note" id="errDivision" style="display:none">디비전을 선택해주세요</div>
        </div>
      </div>
      <div class="nextbar">
        <button class="next" data-next="#step1" data-dir="prev">← 이전</button>
        <button class="next primary" data-next="#step3" data-validate="1">다음 →</button>
      </div>
    </div>

    <!-- 3) 유니폼 색상 -->
    <div class="step" id="step3">
      <div class="section-title">③ 유니폼 색상</div>

      <div>
        <label>홈 색상</label>
        <div class="color-grid">
          <input class="hex" id="uniformHome" placeholder="#ff0000" value="#ff0000" />
          <label for="uniformHomePicker" class="color-btn">색상선택</label>
        </div>
      </div>
      <div style="margin-top:8px">
        <label>어웨이 색상</label>
        <div class="color-grid">
          <input class="hex" id="uniformAway" placeholder="#ffffff" value="#ffffff" />
          <label for="uniformAwayPicker" class="color-btn">색상선택</label>
        </div>
      </div>

      <input type="color" id="uniformHomePicker" class="visually-hidden" value="#ff0000" />
      <input type="color" id="uniformAwayPicker" class="visually-hidden" value="#ffffff" />

      <div class="uniform-row">
        <div class="jersey-card">
          <div class="jersey-title">홈</div>
          <svg id="jerseyHome" class="jersey" viewBox="0 0 120 140" xmlns="http://www.w3.org/2000/svg" aria-label="홈 유니폼"></svg>
        </div>
        <div class="jersey-card">
          <div class="jersey-title">어웨이</div>
          <svg id="jerseyAway" class="jersey" viewBox="0 0 120 140" xmlns="http://www.w3.org/2000/svg" aria-label="어웨이 유니폼"></svg>
        </div>
      </div>

      <div id="contrastWarn" class="muted" style="display:none;margin-top:8px">유니폼 색상 대비가 낮아 번호/이름 가독성이 떨어질 수 있어요.</div>

      <div class="nextbar">
        <button class="next" data-next="#step2" data-dir="prev">← 이전</button>
        <button class="next primary" data-next="#step4" data-validate="1">다음 →</button>
      </div>
    </div>

    <!-- 4) 선수 명단 -->
    <div class="step" id="step4">
      <div class="section-title">④ 선수 명단</div>
      <div class="toolbar" style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn-sm" id="addPlayerBtn" type="button">선수 추가 +</button>
        <button class="btn-sm" id="togglePasteBtn" type="button">명단 붙여넣기</button>
        <button class="btn-sm" id="copySampleBtn" type="button">샘플복사</button>
      </div>
      <div id="pastePanel" style="display:none;margin-top:8px">
        <div class="muted">형식: <b>이름/백넘버/포지션/생년월일(YYMMDD)/선출 또는 비선출</b></div>
        <textarea id="pasteText" style="height:120px;resize:vertical" placeholder="예)
홍길동/7/G/010302/비선출
김철수/11/F/000615/선출"></textarea>
        <div style="display:flex;gap:8px">
          <button class="btn-sm" id="pasteApplyBtn" type="button">붙여넣기 적용</button>
          <button class="btn-sm" id="pasteClearBtn" type="button">지우기</button>
        </div>
      </div>
      <div id="players"></div>
      <div class="muted">※ 최소 5명 권장. 팀 내 등번호 중복 없도록 확인해 주세요.</div>
      <button class="btn" id="submitBtn">신청서 제출</button>
      <div class="nextbar"><button class="next" data-next="#step3" data-dir="prev">← 이전</button></div>

      <div id="editLinkWrap" style="display:none;margin-top:12px">
        <div class="muted" style="margin-bottom:6px;">수정 링크</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="editLinkInput" type="text" readonly style="flex:1">
          <button class="btn-sm" id="copyEditLinkBtn" type="button">복사</button>
        </div>
        <div id="qr" style="display:none;margin-top:8px;text-align:center">
          <img alt="수정 링크 QR" style="width:140px;height:140px;border-radius:12px;border:1px solid #e6ecf5;background:#fff">
        </div>
      </div>
    </div>

    <div class="toast" id="toast">완료!</div>
  </div>
</div>

<script>
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';
  const qs=new URLSearchParams(location.search); const editTeamId=qs.get('edit'); const editCode=qs.get('code');
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const show = msg => { const t=$('.toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };

  // 수정(본인인증) 상태 플래그
  let ownerEdit = null; // {teamId, name, phone}

  /* 로고 폴백 */
  (function fixLogo(){
    const el=$('#bdrLogo');
    const fallback2='https://raw.githubusercontent.com/cobby8/assets/main/bdr-logo.png';
    const inline='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="36"><rect width="120" height="36" fill="white"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-weight="700" font-family="sans-serif" fill="#111">BDR</text></svg>');
    el.onerror=()=>{ if(el.dataset.fallback==='1'){ el.src=inline; } else { el.dataset.fallback='1'; el.src=fallback2; } };
  })();

  /* 단계 이동 */
  $$('.next').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target=btn.getAttribute('data-next'); if(!target) return;
      const needValidate=btn.hasAttribute('data-validate');
      if(needValidate){ const curr=btn.closest('.step'); if(!validateStep(curr.id)) return; }
      $$('.step').forEach(s=>s.classList.remove('active'));
      document.querySelector(target).classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  /* 대회 목록/카드 */
  let TOUR_MAP={}, currentTour=null;
  async function loadTournaments(){
    const res=await fetch(`${WEB_APP_URL}?path=tournaments`);
    const json=await res.json();
    if(!json.ok) return;
    const sel=$('#tourSelect'); sel.innerHTML='<option value="">대회를 선택하세요</option>';
    (json.rows||[]).forEach(t=>{
      const key=t.TourID||t.tourId; TOUR_MAP[key]=t;
      const opt=document.createElement('option'); opt.value=key;
      const period=(t.start||t.end)?` · ${fmtDate(t.start)}~${fmtDate(t.end)}`:'';
      opt.textContent=`${t.name}${t.status?' ('+t.status+')':''}${period}`; sel.appendChild(opt);
    });
  }
  function pad2(n){return String(n).padStart(2,'0');}
  function fmtDate(v){ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return v; return `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`; }
  function fmtDT(v){ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return v; return `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
  function summarizeDivs(divs){ try{ const obj=(typeof divs==='string')?JSON.parse(divs||'{}'):(divs||{}); const parts=Object.keys(obj).map(cat=>{ const arr=Array.isArray(obj[cat])?obj[cat]:[]; return arr.length?`${cat}: ${arr.join('·')}`:`${cat}`; }); return parts.length?parts.join(' / '):'-'; }catch{return '-';} }
  function parsePlaces(p){ try{ const arr=Array.isArray(p)?p:JSON.parse(p||'[]'); const names=(arr||[]).map(v=>typeof v==='string'?v:(v&&v.name)||'').filter(Boolean); return names.length?names.join(' · '):'-'; }catch{return '-';} }
  // 신청서의 renderTourInfo(t) 교체본
function renderTourInfo(t){
  const box = document.getElementById('tourInfo');
  const nextbar = document.getElementById('nextbar0') || {style:{display:'none'}};
  if (!t){ box.style.display='none'; box.innerHTML=''; nextbar.style.display='none'; return; }

  const hasPoster = typeof t.url === 'string' && t.url.startsWith('data:image');
  const posterHtml = hasPoster
    ? `<div style="margin-top:8px"><img src="${t.url}" alt="포스터" style="max-width:220px;max-height:220px;border:1px solid #e6ecf5;border-radius:12px;object-fit:contain;background:#fff"></div>`
    : (t.url ? `<b>안내페이지</b><div><a href="${t.url}" target="_blank" rel="noopener">${t.url}</a></div>` : '');

  const summarizeDivs = (divs) => {
    try {
      const obj=(typeof divs==='string')?JSON.parse(divs||'{}'):(divs||{});
      const parts=Object.keys(obj).map(cat=>{
        const arr=Array.isArray(obj[cat])?obj[cat]:[]; return arr.length?`${cat}: ${arr.join('·')}`:`${cat}`;
      });
      return parts.length?parts.join(' / '):'-';
    } catch { return '-'; }
  };
  const parsePlaces = (p) => {
    try {
      const arr=Array.isArray(p)?p:JSON.parse(p||'[]'); const names=(arr||[]).map(v=>typeof v==='string'?v:(v&&v.name)||'').filter(Boolean);
      return names.length?names.join(' · '):'-';
    } catch { return '-'; }
  };
  const pad2=n=>String(n).padStart(2,'0');
  const fmtDate=v=>{ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return v; return `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`; };
  const fmtDT=v=>{ if(!v) return ''; const d=new Date(v); if(isNaN(d)) return v; return `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`; };

  box.innerHTML = `<div class="kv">
      <b>대회명</b><div>${t.name||'-'}</div>
      <b>종별</b><div>${summarizeDivs(t.divs)}</div>
      <b>일시</b><div>${(t.start||t.end)?`${fmtDate(t.start)} ~ ${fmtDate(t.end)}`:'일정미정'}</div>
      <b>장소</b><div>${parsePlaces(t.places)}</div>
      <b>접수기간</b><div>${(t.regStart||t.regEnd)?`${fmtDT(t.regStart)} ~ ${fmtDT(t.regEnd)}`:'미정'}</div>
      ${posterHtml}
    </div>`;
  box.style.display='block'; nextbar.style.display='flex';
}
  $('#tourSelect').addEventListener('change',e=>{
    const id=e.target.value; currentTour=id?TOUR_MAP[id]:null;
    renderTourInfo(currentTour); fillCategoriesFromTour(currentTour);
  });

  /* 종별/디비전 제한 */
  const categorySelect=$('#category'), divisionSelect=$('#division');
  function fillCategoriesFromTour(t){
    categorySelect.innerHTML=''; divisionSelect.innerHTML='<option value="">종별을 먼저 선택하세요</option>'; divisionSelect.disabled=true;
    if(!t || !t.divs || !Object.keys(t.divs).length){ categorySelect.disabled=true; categorySelect.innerHTML='<option value="">대회에 종별/디비전 설정이 없습니다</option>'; return; }
    categorySelect.disabled=false; categorySelect.appendChild(new Option('선택','')); Object.keys(t.divs).forEach(cat=> categorySelect.appendChild(new Option(cat,cat)));
  }
  categorySelect.addEventListener('change',e=>{
    const cat=e.target.value; divisionSelect.innerHTML='';
    if(!currentTour || !cat){ divisionSelect.disabled=true; divisionSelect.innerHTML='<option value="">종별을 먼저 선택하세요</option>'; return; }
    const arr=currentTour.divs[cat]||[]; if(!arr.length){ divisionSelect.disabled=true; divisionSelect.innerHTML='<option value="">해당 종별의 디비전 없음</option>'; return; }
    divisionSelect.disabled=false; divisionSelect.appendChild(new Option('선택','')); arr.forEach(dv=>divisionSelect.appendChild(new Option(dv,dv)));
  });

  /* 연락처 숫자만 */
  $('#ownerPhone').addEventListener('input',e=> e.target.value=(e.target.value||'').replace(/\D+/g,'').slice(0,11));
  $('#managerPhone').addEventListener('input',e=> e.target.value=(e.target.value||'').replace(/\D+/g,'').slice(0,11));

  /* 시도/시군구 */
  const regionMap={'서울특별시':['강남구','강동구','강북구','강서구','관악구','광진구','구로구','금천구','노원구','도봉구','동대문구','동작구','마포구','서대문구','서초구','성동구','성북구','송파구','양천구','영등포구','용산구','은평구','종로구','중구','중랑구'],
  '부산광역시':['강서구','금정구','남구','동구','동래구','부산진구','북구','사상구','사하구','서구','수영구','연제구','영도구','중구','해운대구','기장군'],
  '대구광역시':['남구','달서구','동구','북구','서구','수성구','중구','달성군','군위군'],
  '인천광역시':['강화군','계양구','미추홀구','남동구','동구','부평구','서구','연수구','중구','옹진군'],
  '광주광역시':['광산구','남구','동구','북구','서구'],
  '대전광역시':['대덕구','동구','서구','유성구','중구'],
  '울산광역시':['남구','동구','북구','중구','울주군'],
  '세종특별자치시':['세종시'],
  '경기도':['가평군','고양시','과천시','광명시','광주시','구리시','군포시','김포시','남양주시','동두천시','부천시','성남시','수원시','시흥시','안산시','안성시','안양시','양주시','양평군','여주시','연천군','오산시','용인시','의왕시','의정부시','이천시','파주시','평택시','포천시','하남시','화성시'],
  '강원특별자치도':['강릉시','동해시','속초시','삼척시','원주시','춘천시','태백시','고성군','양구군','양양군','영월군','인제군','정선군','철원군','평창군','홍천군','화천군','횡성군'],
  '충청북도':['제천시','청주시','충주시','괴산군','단양군','보은군','영동군','옥천군','음성군','증평군'],
  '충청남도':['계룡시','공주시','논산시','당진시','보령시','서산시','아산시','천안시','금산군','부여군','서천군','예산군','청양군','태안군','홍성군'],
  '전북특별자치도':['전주시','군산시','익산시','정읍시','남원시','김제시','완주군','고창군','무주군','부안군','순창군','임실군','장수군','진안군'],
  '전라남도':['광양시','나주시','목포시','순천시','여수시','강진군','고흥군','곡성군','구례군','담양군','무안군','보성군','신안군','영광군','영암군','완도군','장성군','장흥군','진도군','함평군','해남군','화순군'],
  '경상북도':['경산시','경주시','구미시','김천시','문경시','상주시','안동시','영주시','영천시','포항시','고령군','군위군','봉화군','성주군','영덕군','영양군','예천군','울릉군','울진군','의성군','청도군','청송군','칠곡군'],
  '경상남도':['거제시','김해시','밀양시','사천시','양산시','진주시','창원시','통영시','거창군','고성군','남해군','산청군','의령군','창녕군','하동군','함안군','함양군','합천군'],
  '제주특별자치도':['제주시','서귀포시']};
  $('#province').addEventListener('change',e=>{
    const prov=e.target.value; const citySel=$('#city'); citySel.innerHTML='';
    if(!prov){ citySel.disabled=true; citySel.innerHTML='<option value="">시도를 먼저 선택하세요</option>'; }
    else{ citySel.disabled=false; citySel.appendChild(new Option('선택','')); (regionMap[prov]||[]).forEach(c=>citySel.appendChild(new Option(c,c))); }
  });

  /* 유니폼 SVG 렌더 */
  function renderJersey(svgEl, hex){
    svgEl.innerHTML = `
      <defs>
        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.15"></feDropShadow>
        </filter>
      </defs>
      <g filter="url(#shadow)">
        <path d="M35 10 L50 10 L54 22 L66 22 L70 10 L85 10 L85 34 L95 42 L95 130 L25 130 L25 42 L35 34 Z"
              fill="${hex}" stroke="#111" stroke-width="1.5"/>
        <path d="M54 22 L60 28 L66 22" fill="none" stroke="#111" stroke-width="2"/>
        <rect x="38" y="60" width="44" height="8" rx="4" fill="rgba(255,255,255,0.25)"/>
        <path d="M35 34 L35 24" stroke="#111" stroke-width="1"/>
        <path d="M85 34 L85 24" stroke="#111" stroke-width="1"/>
      </g>`;
  }
  function syncColor(hexId, pickerId, jerseyId){
    const hexEl=$(hexId), picker=$(pickerId), svg=$(jerseyId);
    function apply(v){
      const val = v.startsWith('#')?v:'#'+v;
      if(!/^#[0-9A-Fa-f]{6}$/.test(val)) return;
      hexEl.value=val; picker.value=val; renderJersey(svg, val); checkContrast();
    }
    picker.addEventListener('input', e=> apply(e.target.value));
    hexEl.addEventListener('input', e=>{ const raw=e.target.value.replace('#',''); if(/^[0-9A-Fa-f]{6}$/.test(raw)) apply('#'+raw); });
    apply(hexEl.value || picker.value || '#000000');
  }
  function hexToRgb(h){ const s=h.replace('#',''); return { r:parseInt(s.slice(0,2),16), g:parseInt(s.slice(2,4),16), b:parseInt(s.slice(4,6),16) }; }
  function relLum({r,g,b}){ const c=[r,g,b].map(v=>{v/=255; return v<=0.03928? v/12.92 : Math.pow((v+0.055)/1.055,2.4)}); return 0.2126*c[0]+0.7152*c[1]+0.0722*c[2]; }
  function contrastRatio(h1,h2){ try{const L1=relLum(hexToRgb(h1)); const L2=relLum(hexToRgb(h2)); const [a,b]=L1>L2?[L1,L2]:[L2,L1]; return (a+0.05)/(b+0.05);}catch{return 7}}
  function checkContrast(){
    const h=$('#uniformHome').value||'', a=$('#uniformAway').value||'';
    const warn=$('#contrastWarn'); const ok1=/^#[0-9A-Fa-f]{6}$/.test(h), ok2=/^#[0-9A-Fa-f]{6}$/.test(a);
    if(!ok1 && !ok2){ warn.style.display='none'; return; }
    const poor = (ok1 && Math.max(contrastRatio(h,'#000'), contrastRatio(h,'#fff')) < 4.5) ||
                 (ok2 && Math.max(contrastRatio(a,'#000'), contrastRatio(a,'#fff')) < 4.5);
    warn.style.display=poor?'block':'none';
  }
  syncColor('#uniformHome','#uniformHomePicker','#jerseyHome');
  syncColor('#uniformAway','#uniformAwayPicker','#jerseyAway');

  /* 선수 카드 & 붙여넣기 */
  function createPlayerCard(){
    const div=document.createElement('div'); div.className='player-card';
    div.style.cssText='border:1px dashed #e6ecf5;border-radius:14px;padding:10px;margin-top:10px;background:#fafcff';
    div.innerHTML = `<div class="row row-3">
      <div><label>선수 이름</label><input data-key="name" placeholder="이름"></div>
      <div><label>등번호</label><input data-key="number" inputmode="numeric" placeholder="예: 7"></div>
      <div><label>포지션</label><select data-key="position"><option value="">선택</option><option>G</option><option>F</option><option>C</option></select></div>
    </div>
    <div class="row row-2" style="margin-top:8px">
      <div><label>생년월일 (선택)</label><input data-key="birth" type="date"></div>
      <div><label>선출여부</label><select data-key="elite"><option value="">선택</option><option>선출</option><option>비선출</option></select></div>
    </div>
    <div style="text-align:right;margin-top:6px"><button class="btn-sm remove" type="button">삭제</button></div>`;
    div.querySelector('.remove').addEventListener('click',()=>div.remove());
    return div;
  }
  const playersDiv=$('#players'); $('#addPlayerBtn').addEventListener('click',()=>playersDiv.appendChild(createPlayerCard()));
  for(let i=0;i<5;i++) $('#addPlayerBtn').click();

  $('#togglePasteBtn').addEventListener('click', ()=>{ const p=$('#pastePanel'); p.style.display=p.style.display==='none'?'block':'none'; });
  $('#pasteClearBtn')?.addEventListener('click', ()=> $('#pasteText').value='' );
  const SAMPLE=`홍길동/7/G/010302/비선출
김철수/11/F/000615/선출`;
  $('#copySampleBtn').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(SAMPLE); show('샘플이 복사되었습니다. 붙여넣기 후 적용을 누르세요.'); }
    catch(e){ const ta=document.createElement('textarea'); ta.value=SAMPLE; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); show('샘플이 복사되었습니다.'); }
    $('#pastePanel').style.display='block'; $('#pasteText').focus();
  });
  function yyToYYYY(yy){ const n=parseInt(yy,10); if(isNaN(n)) return '2000'; return (n>=50?'19':'20') + (n<10?('0'+n):String(n)); }
  function normalizeBirth(s){
    const v=(s||'').replace(/\D/g,'');
    if (v.length===6)  return `${yyToYYYY(v.slice(0,2))}-${v.slice(2,4)}-${v.slice(4,6)}`;
    if (v.length===8)  return `${v.slice(0,4)}-${v.slice(4,6)}-${v.slice(6,8)}`;
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    return '';
  }
  $('#pasteApplyBtn').addEventListener('click', ()=>{
    const text=$('#pasteText').value||''; if(!text.trim()) return;
    const lines=text.replace(/\r\n/g,'\n').split('\n').map(s=>s.trim()).filter(Boolean);
    const allCards=$$('.player-card'); const allEmpty=allCards.length && allCards.every(c=>!c.querySelector('[data-key="name"]').value.trim());
    if(allEmpty) playersDiv.innerHTML='';
    lines.forEach(line=>{
      const cols=line.split(/[\/,\t]| {2,}/).map(s=>s.trim());
      const [name='', number='', position='', birthYY='', elite=''] = cols;
      const card=createPlayerCard();
      card.querySelector('[data-key="name"]').value=name;
      card.querySelector('[data-key="number"]').value=number;
      card.querySelector('[data-key="position"]').value=(position||'').toUpperCase();
      card.querySelector('[data-key="birth"]').value=normalizeBirth(birthYY);
      card.querySelector('[data-key="elite"]').value=elite;
      playersDiv.appendChild(card);
    });
    show('붙여넣기 적용 완료');
  });

  /* 인라인 검증 */
  function setErr(el,noteId,on){ if(!el) return; if(on){ el.classList.add('error'); if(noteId) $('#'+noteId).style.display='block'; } else { el.classList.remove('error'); if(noteId) $('#'+noteId).style.display='none'; } }
  function validateStep(stepId){
    let ok=true;
    if(stepId==='step0'){ const v=$('#tourSelect').value; if(!v){ show('대회를 선택해 주세요'); ok=false; } }
    if(stepId==='step1'){
      const prov=$('#province'), city=$('#city'), tKo=$('#teamNameKo'), tEn=$('#teamNameEn'), man=$('#managerName'), ph=$('#managerPhone');
      const phOk=/^\d{10,11}$/.test(ph.value);
      setErr(prov,'errProvince',!prov.value); setErr(city,'errCity',!city.value);
      setErr(tKo,'errTeamNameKo',!tKo.value.trim()); setErr(tEn,'errTeamNameEn',!tEn.value.trim());
      setErr(man,'errManagerName',!man.value.trim()); setErr(ph,'errPhone',!phOk);
      ok = prov.value && city.value && tKo.value.trim() && tEn.value.trim() && man.value.trim() && phOk;
      if(!ok) show('필수 항목을 확인해 주세요');
    }
    if(stepId==='step2'){ const cat=$('#category'), div=$('#division'); setErr(cat,'errCategory',!cat.value); setErr(div,'errDivision',!div.value); ok=!!(cat.value&&div.value); if(!ok) show('종별/디비전을 선택해 주세요'); }
    return ok;
  }

  /* 본인 신청서 찾기/불러오기 */
  $('#ownerFindBtn').addEventListener('click', async ()=>{
    const name=$('#ownerName').value.trim(); const phone=($('#ownerPhone').value||'').replace(/\D/g,'');
    if(!name || phone.length<8){ show('이름과 연락처(숫자만)를 입력하세요'); return; }
    try{
      const res=await fetch(`${WEB_APP_URL}?path=findteam&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}`);
      const json=await res.json();
      if(!json.ok){ alert('오류: '+(json.error||'fail')); return; }
      const list=json.items||[];
      if(list.length===0){ show('일치하는 신청서가 없습니다.'); $('#ownerResult').style.display='none'; return; }
      const sel=$('#ownerTeamSel'); sel.innerHTML='';
      list.forEach(it=>{
        const txt=`${it.teamNameKo||'(팀명없음)'} / ${it.tourName||'-'} ${it.category?(' / '+it.category):''}${it.division?(' '+it.division):''}`;
        sel.appendChild(new Option(txt, it.teamId));
      });
      $('#ownerResult').style.display='block';
    }catch(e){ alert('네트워크 오류'); }
  });

  $('#ownerLoadBtn').addEventListener('click', async ()=>{
    const teamId=$('#ownerTeamSel').value; const name=$('#ownerName').value.trim(); const phone=($('#ownerPhone').value||'').replace(/\D/g,'');
    if(!teamId){ show('신청서를 선택하세요'); return; }
    try{
      const url=`${WEB_APP_URL}?path=getTeamByOwner&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}&teamId=${encodeURIComponent(teamId)}`;
      const res=await fetch(url); const json=await res.json();
      if(!json.ok){ alert('오류: '+(json.error||'fail')); return; }
      ownerEdit = {teamId, name, phone}; // 수정 모드 플래그
      // 폼 채우기
      const t=json.team||{}; const pls=json.players||[];
      if (t.tourId && TOUR_MAP[t.tourId]) {
        $('#tourSelect').value = t.tourId; currentTour = TOUR_MAP[t.tourId];
        renderTourInfo(currentTour); fillCategoriesFromTour(currentTour);
      }
      $('#province').value = t.province || '';
      $('#province').dispatchEvent(new Event('change'));
      setTimeout(()=>{ $('#city').value = t.city || ''; }, 0);
      $('#teamNameKo').value = t.teamNameKo || '';
      $('#teamNameEn').value = t.teamNameEn || '';
      $('#managerName').value = t.managerName || '';
      $('#managerPhone').value = (t.managerPhone||'').replace(/\D/g,'');
      if (t.category){ $('#category').value = t.category; $('#category').dispatchEvent(new Event('change')); setTimeout(()=>{ if (t.division) $('#division').value = t.division; }, 0); }
      $('#uniformHome').value = t.uniformHome || '#ff0000';
      $('#uniformAway').value = t.uniformAway || '#ffffff';
      $('#uniformHomePicker').value = $('#uniformHome').value;
      $('#uniformAwayPicker').value = $('#uniformAway').value;
      // 선수
      const container=$('#players'); container.innerHTML='';
      (pls||[]).forEach(pl=>{
        const card=createPlayerCard();
        card.querySelector('[data-key="name"]').value = pl.name || pl['선수이름'] || '';
        card.querySelector('[data-key="number"]').value = pl.number || pl['등번호'] || '';
        card.querySelector('[data-key="position"]').value = (pl.position || pl['포지션'] || '').toUpperCase();
        card.querySelector('[data-key="birth"]').value = pl.birth || pl['생년월일'] || '';
        card.querySelector('[data-key="elite"]').value = pl.elite || pl['선출여부'] || '';
        container.appendChild(card);
      });
      show('신청서가 불러와졌습니다. 수정 후 제출하세요.');
      // 다음 단계로 이동
      $$('.step').forEach(s=>s.classList.remove('active')); $('#step1').classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    }catch(e){ alert('네트워크 오류'); }
  });

  /* 제출 */
  function collectPlayers(){
    return $$('.player-card').map(card=>{
      const get=k=> (card.querySelector(`[data-key="${k}"]`)?.value || '').trim();
      return { name:get('name'), number:get('number'), position:get('position'), birth:get('birth'), elite:get('elite') };
    }).filter(p=>p.name);
  }

  $('#submitBtn').addEventListener('click', async ()=>{
    if (!validateStep('step0') || !validateStep('step1') || !validateStep('step2')) return;
    const province=$('#province').value.trim(), city=$('#city').value.trim();
    const team={
      tourId: $('#tourSelect').value.trim(),
      tourName: (currentTour&&currentTour.name)||'',
      region: province && city ? `${province} ${city}` : '',
      province, city,
      teamNameKo: $('#teamNameKo').value.trim(),
      teamNameEn: $('#teamNameEn').value.trim(),
      teamName  : $('#teamNameKo').value.trim(),
      managerName: $('#managerName').value.trim(),
      managerPhone: ($('#managerPhone').value||'').replace(/\D+/g,''),
      category: $('#category').value,
      division: $('#division').value,
      uniformHome: $('#uniformHome').value.trim(),
      uniformAway: $('#uniformAway').value.trim()
    };
    const players=collectPlayers();
    if (players.length < 5){ alert('선수는 최소 5명 이상 입력해 주세요.'); return; }
    const numbers=players.map(p=>p.number).filter(Boolean);
    const dup=numbers.find((n,i)=> n && numbers.indexOf(n)!==i);
    if (dup){
      $$('.player-card [data-key="number"]').forEach(inp=>{ inp.classList.toggle('error', inp.value===dup); });
      if(!confirm(`등번호 ${dup}가 중복됩니다. 그대로 제출할까요?`)) return;
    }

    // 엔드포인트 결정: 링크 수정 / 본인인증 수정 / 신규
    const payload={team, players, base: location.origin + location.pathname};
    let url = `${WEB_APP_URL}?path=registerteam`;
    if (ownerEdit && ownerEdit.teamId){
      payload.teamId = ownerEdit.teamId;
      payload.name   = ownerEdit.name;
      payload.phone  = ownerEdit.phone;
      url = `${WEB_APP_URL}?path=updateteambyowner`;
    } else if (qs.get('edit') && qs.get('code')) {
      payload.teamId  = qs.get('edit');
      payload.editCode= qs.get('code');
      url = `${WEB_APP_URL}?path=updateteam`;
    }

    const btn=$('#submitBtn'); const bak=btn.textContent; btn.disabled=true; btn.textContent='제출 중...';
    try{
      const res=await fetch(url,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(payload)});
      const json=await res.json();
      if(json.ok){
        btn.textContent= ownerEdit ? '수정 완료' : (qs.get('edit') ? '수정 완료' : '제출 완료');
        btn.classList.add('done'); show(ownerEdit || qs.get('edit') ? '수정이 저장되었습니다.' : '신청이 완료되었습니다.');
        // 완료 후 수정링크도 표시(선택)
        if (!ownerEdit) {
          const editUrl = json.editUrl || `${location.origin}${location.pathname}?edit=${encodeURIComponent(json.teamId)}&code=${encodeURIComponent(json.editCode)}`;
          $('#editLinkInput').value=editUrl; $('#editLinkWrap').style.display='block';
          const img=$('#qr img'); img.src='https://chart.googleapis.com/chart?chs=160x160&cht=qr&chl='+encodeURIComponent(editUrl); $('#qr').style.display='block';
        }
      }else{
        alert('오류: '+(json.error||'unknown')); btn.disabled=false; btn.textContent=bak;
      }
    }catch(err){ alert('네트워크 오류\n'+err); btn.disabled=false; btn.textContent=bak; }
  });

  $('#copyEditLinkBtn').addEventListener('click', async ()=>{
    const val=$('#editLinkInput').value;
    try{ await navigator.clipboard.writeText(val); show('링크가 복사되었습니다.'); }
    catch(e){ const i=$('#editLinkInput'); i.select(); document.execCommand('copy'); show('링크가 복사되었습니다.'); }
  });

  /* 초기화 */
  (async function init(){
    await loadTournaments();
    renderTourInfo(TOUR_MAP[$('#tourSelect').value]||null);
  })();
</script>
</body>
</html>
