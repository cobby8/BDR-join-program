/** ===============================================================
 * BDR Admin Backend (Sheets + GAS)
 * EN schema + legacy absorption + KST time fix
 *
 * GET : ?path=health | tournaments | teams | getTeam
 * POST: ?path=upsertTournament | removeTournament | registerTeam | updateTeam
 *       (path는 대소문자 무시)
 *
 * Tournaments header (row1, exact order):
 *  tourId | name | url | start | end | regStart | regEnd | status
 *  | divSets | divs | places | adminCode | createdAt | updatedAt
 *
 * Teams header (row1, exact order):
 *  teamId | tourId | tourName | teamNameKo | teamNameEn | region | province | city
 *  | managerName | managerPhone | category | division
 *  | uniformHome | uniformAway | players | editCode | createdAt | updatedAt
 * =============================================================== */

const CONF = {
  TOURNAMENT_SHEET_CANDIDATES: ['tournaments','대회','Tournaments'],
  TEAM_SHEET_CANDIDATES      : ['teams','신청','Teams','신청팀','접수'],

  // ---- Tournaments ----
  HEADERS: [
    'tourId','name','url','start','end','regStart','regEnd','status',
    'divSets','divs','places','adminCode','createdAt','updatedAt'
  ],
  ALIASES: {
    tourId    : ['tourId','TourID','대회id','ID','Id','id'],
    name      : ['name','대회명'],
    url       : ['url','안내페이지 url','안내URL','pageUrl'],
    start     : ['start','대회시작','event.start','eventStart'],
    end       : ['end','대회종료','event.end','eventEnd'],
    regStart  : ['regStart','reg.start','reg_start','regStartDate','reg.start.date','접수시작'],
    regEnd    : ['regEnd','reg.end','reg_end','regEndDate','reg.end.date','접수종료'],
    status    : ['status','상태'],
    divSets   : ['divSets','종별구분'],
    divs      : ['divs','종별','divisions','divs_json'],
    places    : ['places','장소'],
    adminCode : ['adminCode','관리코드'],
    createdAt : ['createdAt','created_at','최초생성'],
    updatedAt : ['updatedAt','updated_at','마지막수정'],
    'admin.salt': ['admin.salt','salt'],
    'admin.hash': ['admin.hash','hash']
  },

  // ---- Teams ----
  TEAM_HEADERS: [
    'teamId','tourId','tourName','teamNameKo','teamNameEn','region','province','city',
    'managerName','managerPhone','category','division',
    'uniformHome','uniformAway','players','editCode','createdAt','updatedAt'
  ],
  TEAM_ALIASES: {
    teamId      : ['teamId','팀id','TeamID','TEAMID','id'],
    tourId      : ['tourId','TourID','대회id'],
    tourName    : ['tourName','대회명'],
    teamNameKo  : ['teamNameKo','teamName','팀명','팀명(한글)'],
    teamNameEn  : ['teamNameEn','영문팀명','team_en','팀명(영문)'],
    region      : ['region','지역'],
    province    : ['province','시도'],
    city        : ['city','시군구'],
    managerName : ['managerName','대표자','담당자','manager'],
    managerPhone: ['managerPhone','연락처','phone','tel'],
    category    : ['category','종별'],
    division    : ['division','디비전'],
    uniformHome : ['uniformHome','homeColor','홈유니폼'],
    uniformAway : ['uniformAway','awayColor','원정유니폼'],
    players     : ['players','선수명단','players_json'],
    editCode    : ['editCode','code','수정코드'],
    createdAt   : ['createdAt','created_at','최초생성'],
    updatedAt   : ['updatedAt','updated_at','마지막수정']
  },

  LEGACY_KEEP: []
};

/* --------------------------- Utilities --------------------------- */
const TZ = 'Asia/Seoul';
function nowIsoTz(){
  return Utilities.formatDate(new Date(), TZ, "yyyy-MM-dd'T'HH:mm:ss.SSSXXX");
}
const J = JSON;
function pad(n){ return String(n).padStart(2,'0'); }
function dstr(v, withTime){
  if (!v) return '';
  const d = (v instanceof Date)? v : new Date(v);
  if (isNaN(d)) return '';
  return withTime
    ? d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes())
    : d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());
}
function parseJSON(s, fb){ try{ return J.parse(s); }catch(e){ return fb; } }
function has(v){ return String(v||'').trim() !== ''; }
function onlyDigits(s){ return String(s||'').replace(/\D+/g,''); }
function genId_(prefix){
  return (prefix||'X') + (Date.now().toString(36)+Math.random().toString(36).slice(2,7)).toUpperCase();
}
function genCode_(n){
  var chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  var s=''; for(var i=0;i<(n||6);i++) s+=chars.charAt(Math.floor(Math.random()*chars.length));
  return s;
}

/* --------------------------- Sheet helpers --------------------------- */
function getSheetByCandidates_(names, createName){
  const ss=SpreadsheetApp.getActiveSpreadsheet();
  for (var i=0;i<names.length;i++){ var sh=ss.getSheetByName(names[i]); if (sh) return sh; }
  return ss.insertSheet(createName || names[0]);
}
function readHeader_(sh){
  const last=sh.getLastColumn()||1;
  const h=sh.getRange(1,1,1,last).getValues()[0];
  var end=h.length; while(end>0 && String(h[end-1]||'').trim()==='') end--;
  return h.slice(0,end);
}
function findCol_(hdr, key, aliases){
  const cand = (aliases && aliases[key]) ? aliases[key] : (CONF.ALIASES[key] || [key]);
  for (var i=0;i<cand.length;i++){ var pos=hdr.indexOf(cand[i]); if (pos>=0) return pos+1; }
  return 0;
}
function getVal_(row, hdr, key, aliases){
  const cand = (aliases && aliases[key]) ? aliases[key] : (CONF.ALIASES[key] || [key]);
  for (var i=0;i<cand.length;i++){ var idx=hdr.indexOf(cand[i]); if (idx>=0) return row[idx]; }
  return '';
}

/** ---------- Tournaments: header normalize/order ---------- */
function ensureTournamentHeaderOrder_(){
  const sh = getSheetByCandidates_(CONF.TOURNAMENT_SHEET_CANDIDATES, CONF.TOURNAMENT_SHEET_CANDIDATES[0]);
  const curHdr = readHeader_(sh);
  if (curHdr.length === 0){
    sh.getRange(1,1,1,CONF.HEADERS.length).setValues([CONF.HEADERS]);
    return sh;
  }
  const newHdr = CONF.HEADERS.slice();
  const lastRow = sh.getLastRow();
  const rows = lastRow>1 ? sh.getRange(2,1,lastRow-1,sh.getLastColumn()).getValues() : [];
  const normalized = rows.map(function(row){
    var tourId   = String(getVal_(row, curHdr, 'tourId')||'').trim();
    var name     = String(getVal_(row, curHdr, 'name')||'').trim();
    var url      = String(getVal_(row, curHdr, 'url')||'').trim();

    var start    = dstr(getVal_(row, curHdr, 'start'));
    var end      = dstr(getVal_(row, curHdr, 'end'));
    var regStart = dstr(getVal_(row, curHdr, 'regStart'), true);
    var regEnd   = dstr(getVal_(row, curHdr, 'regEnd'), true);

    var status   = String(getVal_(row, curHdr, 'status')||'').trim();

    var divSets = parseJSON(String(getVal_(row, curHdr, 'divSets')||''), null);
    var divsObj = parseJSON(String(getVal_(row, curHdr, 'divs')||''), null);
    if (!divsObj) divsObj = {};
    if (!divSets && divsObj && typeof divsObj==='object'){
      divSets = Object.keys(divsObj).map(function(g){ return {group:g, divisions:Array.isArray(divsObj[g])?divsObj[g]:[]}; });
    }

    var places = parseJSON(String(getVal_(row, curHdr, 'places')||''), null);
    if (!places) places = [];
    if (Array.isArray(places)){
      places = places.map(function(p){
        if (p && typeof p==='object'){ return { name: String(p.name || p.address || '') }; }
        return { name: String(p||'') };
      });
    }

    var adminCode = String(getVal_(row, curHdr, 'adminCode')||'').trim();
    var createdAt = String(getVal_(row, curHdr, 'createdAt')||'').trim() || nowIsoTz();
    var updatedAt = String(getVal_(row, curHdr, 'updatedAt')||'').trim();

    return [
      tourId, name, url, start, end, regStart, regEnd, status,
      J.stringify(divSets||[]),
      J.stringify(divsObj||{}),
      J.stringify(places||[]),
      adminCode,
      createdAt, updatedAt
    ];
  });

  sh.clear();
  sh.getRange(1,1,1,newHdr.length).setValues([newHdr]);
  if (normalized.length) sh.getRange(2,1,normalized.length,newHdr.length).setValues(normalized);
  return sh;
}

function headerIndex_(sh){
  const hdr=readHeader_(sh); var idx={};
  CONF.HEADERS.forEach(function(h){ var c=findCol_(hdr,h); if (c) idx[h]=c; });
  return idx;
}

/** ---------- Teams: header normalize/order ---------- */
function ensureTeamHeaderOrder_(){
  const sh = getSheetByCandidates_(CONF.TEAM_SHEET_CANDIDATES, CONF.TEAM_SHEET_CANDIDATES[0]);
  const curHdr = readHeader_(sh);
  if (curHdr.length === 0){
    sh.getRange(1,1,1,CONF.TEAM_HEADERS.length).setValues([CONF.TEAM_HEADERS]);
    return sh;
  }
  const newHdr = CONF.TEAM_HEADERS.slice();
  const lastRow = sh.getLastRow();
  const rows = lastRow>1 ? sh.getRange(2,1,lastRow-1,sh.getLastColumn()).getValues() : [];
  const A = CONF.TEAM_ALIASES;

  const normalized = rows.map(function(row){
    var teamId      = String(getVal_(row, curHdr, 'teamId', A)      ||'').trim();
    var tourId      = String(getVal_(row, curHdr, 'tourId', A)      ||'').trim();
    var tourName    = String(getVal_(row, curHdr, 'tourName', A)    ||'').trim();
    var teamNameKo  = String(getVal_(row, curHdr, 'teamNameKo', A)  || getVal_(row, curHdr, 'teamName', A) || '').trim();
    var teamNameEn  = String(getVal_(row, curHdr, 'teamNameEn', A)  ||'').trim();
    var region      = String(getVal_(row, curHdr, 'region', A)      ||'').trim();
    var province    = String(getVal_(row, curHdr, 'province', A)    ||'').trim();
    var city        = String(getVal_(row, curHdr, 'city', A)        ||'').trim();
    var managerName = String(getVal_(row, curHdr, 'managerName', A) ||'').trim();
    var managerPhone= onlyDigits(getVal_(row, curHdr, 'managerPhone', A) || '');
    var category    = String(getVal_(row, curHdr, 'category', A)    ||'').trim();
    var division    = String(getVal_(row, curHdr, 'division', A)    ||'').trim();
    var uniformHome = String(getVal_(row, curHdr, 'uniformHome', A) ||'').trim();
    var uniformAway = String(getVal_(row, curHdr, 'uniformAway', A) ||'').trim();

    var players     = parseJSON(String(getVal_(row, curHdr, 'players', A) || '[]'), []);
    var editCode    = String(getVal_(row, curHdr, 'editCode', A)   ||'').trim();
    var createdAt   = String(getVal_(row, curHdr, 'createdAt', A)  ||'').trim() || nowIsoTz();
    var updatedAt   = String(getVal_(row, curHdr, 'updatedAt', A)  ||'').trim();

    return [
      teamId, tourId, tourName, teamNameKo, teamNameEn, region, province, city,
      managerName, managerPhone, category, division,
      uniformHome, uniformAway, J.stringify(players||[]), editCode, createdAt, updatedAt
    ];
  });

  sh.clear();
  sh.getRange(1,1,1,newHdr.length).setValues([newHdr]);
  if (normalized.length) sh.getRange(2,1,normalized.length,newHdr.length).setValues(normalized);
  return sh;
}

function teamHeaderIndex_(sh){
  const hdr=readHeader_(sh); var idx={};
  CONF.TEAM_HEADERS.forEach(function(h){ var c=findCol_(hdr,h,CONF.TEAM_ALIASES); if (c) idx[h]=c; });
  return idx;
}

/* --------------------------- Router helpers --------------------------- */
function respond_(obj,e){
  return ContentService.createTextOutput(J.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}
function parseBody_(e){
  try{ if(e&&e.postData&&e.postData.contents) return J.parse(e.postData.contents);}catch(err){}
  const p=e&&e.parameter||{}; if(p.payload){ try{ return J.parse(p.payload);}catch(err){} } return p||{};
}

/* --------------------------- Business: Tournaments --------------------------- */
function listTournaments_(){
  const sh=ensureTournamentHeaderOrder_();
  const hdr=readHeader_(sh);
  const last=sh.getLastRow(); if (last<2) return [];
  const vals=sh.getRange(2,1,last-1,sh.getLastColumn()).getValues();

  const rows=vals.map(function(r){
    function v(k){ var c=findCol_(hdr,k); return c ? r[c-1] : ''; }
    return {
      tourId : String(v('tourId')||''),
      TourID : String(v('tourId')||''), // old frontends
      name   : String(v('name')||''),
      url    : String(v('url')||''),
      start  : String(v('start')||''),
      end    : String(v('end')||''),
      regStart: String(v('regStart')||''),
      regEnd  : String(v('regEnd')||''),
      status : String(v('status')||''),
      divSets: parseJSON(String(v('divSets')||'[]'), []),
      divs   : parseJSON(String(v('divs')||'{}'), {}),
      places : parseJSON(String(v('places')||'[]'), []),
      createdAt: String(v('createdAt')||''),
      updatedAt: String(v('updatedAt')||'')
    };
  });

  rows.sort(function(a,b){ return (b.createdAt||'').localeCompare(a.createdAt||''); });
  return rows;
}
function findTournamentRow_(tourId){
  const sh=ensureTournamentHeaderOrder_(); const hdr=readHeader_(sh);
  const col = findCol_(hdr, 'tourId'); if (!col) return {sh:sh,hdr:hdr,rowIndex:-1};
  const last=sh.getLastRow(); if (last<2) return {sh:sh,hdr:hdr,rowIndex:-1};
  const ids=sh.getRange(2,col,last-1,1).getValues().map(function(v){ return String(v[0]||'').trim(); });
  const pos=ids.indexOf(String(tourId||'').trim());
  return {sh:sh,hdr:hdr,rowIndex:(pos>=0?pos+2:-1)};
}

function upsertTournament_(p){
  const sh=ensureTournamentHeaderOrder_(); const hdr=readHeader_(sh); const idx=headerIndex_(sh);

  const tourIdIn = String(p.tourId||'').trim();
  const name     = String(p.name||'').trim();
  const adminIn  = String(p.adminCode||'').trim();
  if(!name)    return {ok:false,error:'name(대회명)은 필수입니다.'};
  if(!adminIn) return {ok:false,error:'adminCode(관리코드)는 필수입니다.'};

  var rowN=-1;
  if (tourIdIn){
    var f=findTournamentRow_(tourIdIn); if (f.rowIndex>0) rowN=f.rowIndex;
  }

  const now = nowIsoTz();
  function toStrJson(v,fb){ if(typeof v==='string'){ try{J.parse(v); return v;}catch(e){} } return J.stringify(v!=null?v:fb); }
  const normPlaces = Array.isArray(p.places) ? p.places.map(function(x){ return {name:String((x&&x.name)||'')}; }) : [];

  if (rowN===-1){
    const newId = tourIdIn || genId_('T');
    const line = new Array(readHeader_(sh).length).fill('');
    line[idx['tourId']-1]   = newId;
    line[idx['name']-1]     = name;
    line[idx['url']-1]      = String(p.url||'');
    line[idx['start']-1]    = dstr(p.start);
    line[idx['end']-1]      = dstr(p.end);
    line[idx['regStart']-1] = dstr(p.regStart || p['reg.start'] || p.reg_start || p.regStartDate || p['reg.start.date'], true);
    line[idx['regEnd']-1]   = dstr(p.regEnd   || p['reg.end']   || p.reg_end   || p.regEndDate   || p['reg.end.date']  , true);
    line[idx['status']-1]   = String(p.status||'');
    line[idx['divSets']-1]  = toStrJson(p.divSets, []);
    line[idx['divs']-1]     = toStrJson(p.divs,    {});
    line[idx['places']-1]   = J.stringify(normPlaces);
    line[idx['adminCode']-1]= adminIn;
    line[idx['createdAt']-1]= now;
    line[idx['updatedAt']-1]= now;
    sh.appendRow(line);
    return {ok:true, tourId:newId, created:true};
  }

  const range = sh.getRange(rowN,1,1,sh.getLastColumn());
  const old = range.getValues()[0];
  const storedAdmin = String(old[idx['adminCode']-1]||'').trim();
  const hadAdmin = has(storedAdmin);
  if (hadAdmin && storedAdmin !== adminIn) return {ok:false,error:'관리코드가 올바르지 않습니다.'};

  var line=old.slice();
  line[idx['name']-1]     = name;
  line[idx['url']-1]      = String(p.url||'');
  line[idx['start']-1]    = dstr(p.start);
  line[idx['end']-1]      = dstr(p.end);
  line[idx['regStart']-1] = dstr(p.regStart || p['reg.start'] || p.reg_start || p.regStartDate || p['reg.start.date'], true);
  line[idx['regEnd']-1]   = dstr(p.regEnd   || p['reg.end']   || p.reg_end   || p.regEndDate   || p['reg.end.date']  , true);
  line[idx['status']-1]   = String(p.status||'');
  function toStrJson2(v,fb){ if(typeof v==='string'){ try{J.parse(v); return v;}catch(e){} } return J.stringify(v!=null?v:fb); }
  line[idx['divSets']-1]  = toStrJson2(p.divSets, parseJSON(String(line[idx['divSets']-1]||'[]'),[]));
  line[idx['divs']-1]     = toStrJson2(p.divs,    parseJSON(String(line[idx['divs']-1]||'{}'),{}));
  line[idx['places']-1]   = J.stringify(normPlaces);
  line[idx['adminCode']-1]= adminIn;
  line[idx['updatedAt']-1]= now;
  range.setValues([line]);
  return {ok:true, tourId:String(line[idx['tourId']-1]||''), created:false};
}
function removeTournament_(p){
  const sh=ensureTournamentHeaderOrder_(); const hdr=readHeader_(sh);
  const tourId=String(p.tourId||'').trim();
  const adminIn=String(p.adminCode||'').trim();
  if(!tourId)  return {ok:false,error:'tourId가 필요합니다.'};
  if(!adminIn) return {ok:false,error:'adminCode가 필요합니다.'};
  const f=findTournamentRow_(tourId); if (f.rowIndex<=0) return {ok:false,error:'대회를 찾을 수 없습니다.'};
  const idx=headerIndex_(sh);
  const rowVals=sh.getRange(f.rowIndex,1,1,sh.getLastColumn()).getValues()[0];
  const storedAdmin = String(rowVals[idx['adminCode']-1]||'').trim();
  if (!has(storedAdmin)) return {ok:false,error:'관리코드가 설정되지 않았습니다. 먼저 저장(수정)으로 설정 후 삭제하세요.'};
  if (storedAdmin !== adminIn) return {ok:false,error:'관리코드가 올바르지 않습니다.'};
  sh.deleteRow(f.rowIndex);
  return {ok:true, removed:true};
}

/* --------------------------- Business: Teams --------------------------- */
function listTeams_(tourIdOpt){
  const sh=ensureTeamHeaderOrder_(); const hdr=readHeader_(sh);
  const last=sh.getLastRow(); if(last<2) return [];
  const vals=sh.getRange(2,1,last-1,sh.getLastColumn()).getValues();
  const rows=vals.map(function(r){
    var o={}; hdr.forEach(function(h,i){ o[h]=r[i]; });
    // 보정
    o.managerPhone = onlyDigits(o.managerPhone);
    o.players = parseJSON(String(o.players||'[]'),[]);
    return o;
  });
  if (tourIdOpt){
    const key = ['tourId','TourID','대회id'].find(function(k){ return hdr.indexOf(k)>=0; }) || 'tourId';
    return rows.filter(function(x){ return String(x[key]||'').trim()===String(tourIdOpt).trim(); });
  }
  return rows;
}

function findTeamRow_(teamId){
  const sh=ensureTeamHeaderOrder_(); const hdr=readHeader_(sh);
  const col = findCol_(hdr, 'teamId', CONF.TEAM_ALIASES); if (!col) return {sh:sh,hdr:hdr,rowIndex:-1};
  const last=sh.getLastRow(); if (last<2) return {sh:sh,hdr:hdr,rowIndex:-1};
  const ids=sh.getRange(2,col,last-1,1).getValues().map(function(v){ return String(v[0]||'').trim(); });
  const pos=ids.indexOf(String(teamId||'').trim());
  return {sh:sh,hdr:hdr,rowIndex:(pos>=0?pos+2:-1)};
}

function registerTeam_(p){
  // 필수: tourId, teamNameKo, teamNameEn
  var t = p && p.team || {};
  var players = p && p.players || [];
  if (!has(t.tourId))      return {ok:false,error:'tourId가 필요합니다.'};
  if (!has(t.teamNameKo))  return {ok:false,error:'팀명(한글)은 필수입니다.'};
  if (!has(t.teamNameEn))  return {ok:false,error:'팀명(영문)은 필수입니다.'};

  const sh=ensureTeamHeaderOrder_(); const hdr=readHeader_(sh); const idx=teamHeaderIndex_(sh);
  const now = nowIsoTz();
  const teamId = genId_('TM');
  const editCode = genCode_(6);

  const line = new Array(readHeader_(sh).length).fill('');
  line[idx['teamId']-1]      = teamId;
  line[idx['tourId']-1]      = String(t.tourId||'').trim();
  line[idx['tourName']-1]    = String(t.tourName||'').trim();
  line[idx['teamNameKo']-1]  = String(t.teamNameKo||'').trim();
  line[idx['teamNameEn']-1]  = String(t.teamNameEn||'').trim();
  line[idx['region']-1]      = String(t.region||'').trim();
  line[idx['province']-1]    = String(t.province||'').trim();
  line[idx['city']-1]        = String(t.city||'').trim();
  line[idx['managerName']-1] = String(t.managerName||'').trim();
  line[idx['managerPhone']-1]= onlyDigits(t.managerPhone||'');
  line[idx['category']-1]    = String(t.category||'').trim();
  line[idx['division']-1]    = String(t.division||'').trim();
  line[idx['uniformHome']-1] = String(t.uniformHome||'').trim();
  line[idx['uniformAway']-1] = String(t.uniformAway||'').trim();
  line[idx['players']-1]     = J.stringify(players||[]);
  line[idx['editCode']-1]    = editCode;
  line[idx['createdAt']-1]   = now;
  line[idx['updatedAt']-1]   = now;

  sh.appendRow(line);

  var base = (p && p.base) || '';
  var editUrl = base ? (base + '?edit=' + encodeURIComponent(teamId) + '&code=' + encodeURIComponent(editCode)) : '';
  return {ok:true, teamId:teamId, editCode:editCode, editUrl:editUrl};
}

function updateTeam_(p){
  var t = p && p.team || {};
  var players = p && p.players || [];
  var teamId = String(p.teamId||'').trim();
  var code   = String(p.editCode||p.code||'').trim();
  if (!has(teamId)) return {ok:false,error:'teamId가 필요합니다.'};

  const f=findTeamRow_(teamId); if (f.rowIndex<=0) return {ok:false,error:'팀을 찾을 수 없습니다.'};
  const sh=f.sh, hdr=f.hdr, idx=teamHeaderIndex_(sh);
  const row = sh.getRange(f.rowIndex,1,1,sh.getLastColumn()).getValues()[0];
  const storedCode = String(row[idx['editCode']-1]||'').trim();
  if (!has(storedCode)) return {ok:false,error:'수정코드가 설정되지 않았습니다.'};
  if (storedCode !== code) return {ok:false,error:'수정코드가 올바르지 않습니다.'};

  // teamNameKo / teamNameEn 모두 필수
  if (!has(t.teamNameKo)) return {ok:false,error:'팀명(한글)은 필수입니다.'};
  if (!has(t.teamNameEn)) return {ok:false,error:'팀명(영문)은 필수입니다.'};

  var line = row.slice();
  line[idx['tourId']-1]      = String(t.tourId||row[idx['tourId']-1]||'').trim();
  line[idx['tourName']-1]    = String(t.tourName||row[idx['tourName']-1]||'').trim();
  line[idx['teamNameKo']-1]  = String(t.teamNameKo||'').trim();
  line[idx['teamNameEn']-1]  = String(t.teamNameEn||'').trim();
  line[idx['region']-1]      = String(t.region||'').trim();
  line[idx['province']-1]    = String(t.province||'').trim();
  line[idx['city']-1]        = String(t.city||'').trim();
  line[idx['managerName']-1] = String(t.managerName||'').trim();
  line[idx['managerPhone']-1]= onlyDigits(t.managerPhone||'');
  line[idx['category']-1]    = String(t.category||'').trim();
  line[idx['division']-1]    = String(t.division||'').trim();
  line[idx['uniformHome']-1] = String(t.uniformHome||'').trim();
  line[idx['uniformAway']-1] = String(t.uniformAway||'').trim();
  line[idx['players']-1]     = J.stringify(players||parseJSON(String(line[idx['players']-1]||'[]'),[]));
  line[idx['updatedAt']-1]   = nowIsoTz();

  sh.getRange(f.rowIndex,1,1,sh.getLastColumn()).setValues([line]);
  return {ok:true, teamId:teamId, updated:true};
}

function getTeam_(p){
  var teamId = String(p.teamId||'').trim();
  var code   = String(p.code||'').trim();
  if (!has(teamId)) return {ok:false,error:'teamId가 필요합니다.'};
  const f=findTeamRow_(teamId); if (f.rowIndex<=0) return {ok:false,error:'팀을 찾을 수 없습니다.'};
  const sh=f.sh, idx=teamHeaderIndex_(sh);
  const row = sh.getRange(f.rowIndex,1,1,sh.getLastColumn()).getValues()[0];
  const storedCode = String(row[idx['editCode']-1]||'').trim();
  if (has(storedCode) && code && storedCode !== code) return {ok:false,error:'수정코드가 올바르지 않습니다.'};

  function g(k){ return row[idx[k]-1]; }
  const team = {
    teamId: g('teamId'),
    tourId: g('tourId'),
    tourName: g('tourName'),
    teamNameKo: g('teamNameKo'),
    teamNameEn: g('teamNameEn'),
    region: g('region'),
    province: g('province'),
    city: g('city'),
    managerName: g('managerName'),
    managerPhone: String(g('managerPhone')||''),
    category: g('category'),
    division: g('division'),
    uniformHome: g('uniformHome'),
    uniformAway: g('uniformAway'),
    createdAt: g('createdAt'),
    updatedAt: g('updatedAt')
  };
  const players = parseJSON(String(g('players')||'[]'),[]);
  return {ok:true, team:team, players:players};
}

/* --------------------------- Router --------------------------- */
function doGet(e){
  const path=(e.parameter && e.parameter.path || '').toLowerCase();
  try{
    if(!path || path==='health')   return respond_({ok:true, now:nowIsoTz()}, e);
    if(path==='tournaments')       return respond_({ok:true, rows:listTournaments_()}, e);
    if(path==='teams')             return respond_({ok:true, rows:listTeams_(e.parameter && e.parameter.tourId)}, e);
    if(path==='getteam')           return respond_(getTeam_(e.parameter||{}), e);
    return respond_({ok:false,error:'unknown path'}, e);
  }catch(err){ return respond_({ok:false,error:String(err&&err.message||err)}, e); }
}
function doPost(e){
  const path=(e.parameter && e.parameter.path || '').toLowerCase();
  const body=parseBody_(e);
  try{
    if(path==='upserttournament')  return respond_(upsertTournament_(body), e);
    if(path==='removetournament')  return respond_(removeTournament_(body), e);
    if(path==='registerteam')      return respond_(registerTeam_(body), e);
    if(path==='updateteam')        return respond_(updateTeam_(body), e);
    return respond_({ok:false,error:'unknown path'}, e);
  }catch(err){ return respond_({ok:false,error:String(err&&err.message||err)}, e); }
}

/* --------------------------- Maintenance --------------------------- */
function REPAIR_TOUR_HEADERS(){ ensureTournamentHeaderOrder_(); }
function REPAIR_TEAM_HEADERS(){ ensureTeamHeaderOrder_(); }
function RECOMPUTE_STATUS(){
  const sh=ensureTournamentHeaderOrder_(); const hdr=readHeader_(sh);
  const last=sh.getLastRow(); if(last<2) return;
  const rsCol=findCol_(hdr,'regStart'), reCol=findCol_(hdr,'regEnd'), stCol=findCol_(hdr,'status'), upCol=findCol_(hdr,'updatedAt');
  if(!(rsCol && reCol && stCol)) return;
  const rg=sh.getRange(2,1,last-1,sh.getLastColumn()); const vals=rg.getValues(); const now=nowIsoTz();
  vals.forEach(function(row){
    const rs=new Date(row[rsCol-1]), re=new Date(row[reCol-1]), n=new Date();
    const st = (!isNaN(rs)&&!isNaN(re)) ? (n<rs?'접수전':(n>re?'마감':'접수중')) : String(row[stCol-1]||'');
    row[stCol-1]=st; if (upCol) row[upCol-1]=now;
  });
  rg.setValues(vals);
}
