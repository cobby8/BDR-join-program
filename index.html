<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR대회 참가신청</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f8fbfd; --card:#fff; --shadow:0 8px 32px #1769ff1a; --radius:18px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:720px;margin:28px auto;padding:16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
  h1{font-size:20px;margin:0 0 14px}
  .section-title{font-weight:700;margin:18px 0 8px}
  label{display:block;font-weight:600;margin:14px 0 6px}
  input,select{width:100%;padding:14px 12px;border:1px solid #e6ecf5;border-radius:14px;font-size:16px;outline:none}
  input:focus,select:focus{border-color:var(--blue)}
  .row{display:grid;gap:12px}
  @media(min-width:560px){ .row-2{grid-template-columns:1fr 1fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  .muted{color:#6b7684;font-size:13px;margin-top:6px}
  .btn{margin-top:18px;width:100%;padding:14px;border:none;border-radius:14px;background:var(--blue);color:#fff;font-weight:700;font-size:17px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.done{background:#2ebf6f} /* ✅ 제출 완료 상태 색상 */
  .btn-sm{padding:8px 12px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer;margin-top:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{width:28px;height:28px;border-radius:50%;border:1px solid #e3e8ef;cursor:pointer}
  .colorbar{display:flex;gap:10px;align-items:center;margin-top:8px}
  .colorbox{flex:1;display:flex;gap:8px;align-items:center}
  .colorhex{width:120px}
  .player-card{border:1px dashed #e6ecf5;border-radius:14px;padding:12px;margin-top:10px;background:#fafcff}
  .player-toolbar{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#222;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s}
  .toast.show{opacity:1}
  /* 날짜 입력 + 캘린더 버튼 */
  .date-field{position:relative;display:flex;align-items:center}
  .date-field input[type="date"]{width:100%;padding:14px 44px 14px 12px;border:1px solid #e6ecf5;border-radius:14px;font-size:16px}
  .calendar-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:1px solid #dfe6ee;background:#fff;border-radius:12px;padding:6px 8px;cursor:pointer}
  .calendar-btn:active{transform:translateY(-50%) scale(0.98)}
  .calendar-btn svg{width:18px;height:18px;display:block}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>팀 참가신청</h1>
    <div class="muted">팀 대표 정보 입력 → 선수 명단 자유 추가/삭제 → 제출</div>

    <!-- ① 팀 기본정보 -->
    <div class="section-title">① 팀 기본정보</div>
    <div class="row row-2">
      <div>
        <label>시도 선택</label>
        <select id="province">
          <option value="">선택</option>
          <option>서울특별시</option>
          <option>부산광역시</option>
          <option>대구광역시</option>
          <option>인천광역시</option>
          <option>광주광역시</option>
          <option>대전광역시</option>
          <option>울산광역시</option>
          <option>세종특별자치시</option>
          <option>경기도</option>
          <option>강원특별자치도</option>
          <option>충청북도</option>
          <option>충청남도</option>
          <option>전북특별자치도</option>
          <option>전라남도</option>
          <option>경상북도</option>
          <option>경상남도</option>
          <option>제주특별자치도</option>
        </select>
      </div>
      <div>
        <label>시군구 선택</label>
        <select id="city" disabled>
          <option value="">시도를 먼저 선택하세요</option>
        </select>
      </div>
    </div>
    <div class="row row-2">
      <div>
        <label>팀명</label>
        <input id="teamName" placeholder="예: 슬로우" />
      </div>
      <div>
        <label>대표자 이름</label>
        <input id="managerName" placeholder="이름" />
      </div>
    </div>
    <div class="row row-2">
      <div>
        <label>대표자 연락처</label>
        <input id="managerPhone" placeholder="010-0000-0000" />
      </div>
    </div>

    <!-- ② 종별/디비전 -->
    <div class="section-title">② 종별/디비전</div>
    <div class="row row-2">
      <div>
        <label>종별</label>
        <select id="category">
          <option value="">선택</option>
          <option>일반부</option>
          <option>대학부</option>
          <option>여성부</option>
          <option>유소년부</option>
          <option>40대부</option>
        </select>
      </div>
      <div>
        <label>디비전</label>
        <select id="division" disabled>
          <option value="">종별을 먼저 선택하세요</option>
        </select>
      </div>
    </div>

    <!-- ③ 유니폼 색상 -->
    <div class="section-title">③ 유니폼 색상</div>

    <label>홈 색상</label>
    <div class="chips" data-target="uniformHome">
      <div class="chip" style="background:#ffffff" data-color="#ffffff"></div>
      <div class="chip" style="background:#000000" data-color="#000000"></div>
      <div class="chip" style="background:#1769ff" data-color="#1769ff"></div>
      <div class="chip" style="background:#ff3b30" data-color="#ff3b30"></div>
      <div class="chip" style="background:#34c759" data-color="#34c759"></div>
      <div class="chip" style="background:#ffcc00" data-color="#ffcc00"></div>
      <div class="chip" style="background:#8e8e93" data-color="#8e8e93"></div>
    </div>
    <div class="colorbar">
      <div class="colorbox">
        <input type="color" id="uniformHomePicker" />
        <input class="colorhex" id="uniformHome" placeholder="#1769ff" />
      </div>
    </div>

    <label>어웨이 색상</label>
    <div class="chips" data-target="uniformAway">
      <div class="chip" style="background:#ffffff" data-color="#ffffff"></div>
      <div class="chip" style="background:#000000" data-color="#000000"></div>
      <div class="chip" style="background:#1769ff" data-color="#1769ff"></div>
      <div class="chip" style="background:#ff3b30" data-color="#ff3b30"></div>
      <div class="chip" style="background:#34c759" data-color="#34c759"></div>
      <div class="chip" style="background:#ffcc00" data-color="#ffcc00"></div>
      <div class="chip" style="background:#8e8e93" data-color="#8e8e93"></div>
    </div>
    <div class="colorbar">
      <div class="colorbox">
        <input type="color" id="uniformAwayPicker" />
        <input class="colorhex" id="uniformAway" placeholder="#000000" />
      </div>
    </div>

    <!-- ④ 선수 명단 -->
    <div class="section-title">④ 선수 명단</div>
    <div id="players"></div>
    <button class="btn-sm" id="addPlayerBtn">선수 추가 +</button>
    <div class="muted">※ 최소 5명 권장. 팀 내 등번호 중복 없도록 확인해 주세요.</div>

    <!-- 제출 -->
    <button class="btn" id="submitBtn">신청서 제출</button>
    <div class="toast" id="toast">제출 완료!</div>
  </div>
</div>

<script>
  // === 설정 ===
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz1qk5MbQvVU3d8Qs3EcPO792iBNlVQR71WhCpNbkqzCcdn5gM17Hqx9AUAIGUwwSKCww/exec';

  // 종별 → 디비전 동적 매핑
  const divisionOptions = {
    '일반부': ['D3','D4','D5','D6','D7'],
    '대학부': ['U1','U2'],
    '여성부': ['D3','D4','D5'],
    '40대부': ['D3','D4','D5'],
    '유소년부': ['하모니','i1','i2','i3','i4']
  };
  const categorySelect = document.getElementById('category');
  const divisionSelect = document.getElementById('division');
  function populateDivision(cat){
    const list = divisionOptions[cat] || [];
    divisionSelect.innerHTML = '';
    if (!cat){
      divisionSelect.disabled = true;
      divisionSelect.innerHTML = '<option value="">종별을 먼저 선택하세요</option>';
      return;
    }
    if (list.length === 0){
      divisionSelect.disabled = true;
      divisionSelect.innerHTML = '<option value="">해당 종별의 디비전 없음</option>';
      return;
    }
    divisionSelect.disabled = false;
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent = '선택';
    divisionSelect.appendChild(opt0);
    list.forEach(v=>{
      const o = document.createElement('option'); o.value = v; o.textContent = v; divisionSelect.appendChild(o);
    });
  }
  categorySelect.addEventListener('change', e=>populateDivision(e.target.value));
  populateDivision('');

  // 유니폼: 컬러칩 ↔ 컬러피커 ↔ HEX
  document.querySelectorAll('.chips').forEach(chipRow => {
    const targetId = chipRow.getAttribute('data-target');
    chipRow.addEventListener('click', e => {
      const chip = e.target.closest('.chip'); if (!chip) return;
      const color = chip.getAttribute('data-color');
      document.getElementById(targetId).value = color;
      const picker = document.getElementById(targetId + 'Picker');
      if (picker) picker.value = color;
    });
  });
  function bindColorSync(pickerId, hexId){
    const picker = document.getElementById(pickerId);
    const hex = document.getElementById(hexId);
    picker.addEventListener('input', () => hex.value = picker.value);
    hex.addEventListener('input', () => {
      const v = hex.value;
      if (/^#?[0-9A-Fa-f]{6}$/.test(v.replace('#',''))) {
        picker.value = v.startsWith('#') ? v : '#' + v;
        hex.value = picker.value;
      }
    });
  }
  bindColorSync('uniformHomePicker','uniformHome');
  bindColorSync('uniformAwayPicker','uniformAway');

  // 시도 → 시군구 데이터
  const regionData = {
    '서울특별시': ['강남구','강동구','강북구','강서구','관악구','광진구','구로구','금천구','노원구','도봉구','동대문구','동작구','마포구','서대문구','서초구','성동구','성북구','송파구','양천구','영등포구','용산구','은평구','종로구','중구','중랑구'],
    '부산광역시': ['강서구','금정구','남구','동구','동래구','부산진구','북구','사상구','사하구','서구','수영구','연제구','영도구','중구','해운대구','기장군'],
    '대구광역시': ['남구','달서구','동구','북구','서구','수성구','중구','달성군','군위군'],
    '인천광역시': ['강화군','계양구','미추홀구','남동구','동구','부평구','서구','연수구','중구','옹진군'],
    '광주광역시': ['광산구','남구','동구','북구','서구'],
    '대전광역시': ['대덕구','동구','서구','유성구','중구'],
    '울산광역시': ['남구','동구','북구','중구','울주군'],
    '세종특별자치시': ['세종시'],
    '경기도': ['가평군','고양시','과천시','광명시','광주시','구리시','군포시','김포시','남양주시','동두천시','부천시','성남시','수원시','시흥시','안산시','안성시','안양시','양주시','양평군','여주시','연천군','오산시','용인시','의왕시','의정부시','이천시','파주시','평택시','포천시','하남시','화성시'],
    '강원특별자치도': ['강릉시','동해시','속초시','삼척시','원주시','춘천시','태백시','고성군','양구군','양양군','영월군','인제군','정선군','철원군','평창군','홍천군','화천군','횡성군'],
    '충청북도': ['제천시','청주시','충주시','괴산군','단양군','보은군','영동군','옥천군','음성군','증평군'],
    '충청남도': ['계룡시','공주시','논산시','당진시','보령시','서산시','아산시','천안시','금산군','부여군','서천군','예산군','청양군','태안군','홍성군'],
    '전북특별자치도': ['전주시','군산시','익산시','정읍시','남원시','김제시','완주군','고창군','무주군','부안군','순창군','임실군','장수군','진안군'],
    '전라남도': ['광양시','나주시','목포시','순천시','여수시','강진군','고흥군','곡성군','구례군','담양군','무안군','보성군','신안군','영광군','영암군','완도군','장성군','장흥군','진도군','함평군','해남군','화순군'],
    '경상북도': ['경산시','경주시','구미시','김천시','문경시','상주시','안동시','영주시','영천시','포항시','고령군','군위군','봉화군','성주군','영덕군','영양군','예천군','울릉군','울진군','의성군','청도군','청송군','칠곡군'],
    '경상남도': ['거제시','김해시','밀양시','사천시','양산시','진주시','창원시','통영시','거창군','고성군','남해군','산청군','의령군','창녕군','하동군','함안군','함양군','합천군'],
    '제주특별자치도': ['제주시','서귀포시']
  };

  const provinceSel = document.getElementById('province');
  const citySel = document.getElementById('city');
  provinceSel.addEventListener('change', e => {
    const prov = e.target.value;
    citySel.innerHTML = '';
    if (!prov) {
      citySel.disabled = true;
      citySel.innerHTML = '<option value="">시도를 먼저 선택하세요</option>';
      return;
    }
    const list = regionData[prov] || [];
    citySel.disabled = false;
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='선택'; citySel.appendChild(opt0);
    list.forEach(city=>{ const o=document.createElement('option'); o.value=city; o.textContent=city; citySel.appendChild(o); });
  });

  // 연령(만 나이) 계산 함수
  function calcAge(yyyyMMdd){
    if(!yyyyMMdd) return '';
    const d = new Date(yyyyMMdd);
    if(Number.isNaN(d.getTime())) return '';
    const today = new Date();
    let age = today.getFullYear() - d.getFullYear();
    const m = today.getMonth() - d.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < d.getDate())) age--;
    return age;
  }

  // 선수 카드 템플릿
  function createPlayerCard(idx){
    const div = document.createElement('div');
    div.className = 'player-card';
    div.innerHTML = `
      <div class="row row-3">
        <div>
          <label>선수 이름</label>
          <input placeholder="이름" data-key="name">
        </div>
        <div>
          <label>등번호</label>
          <input placeholder="예: 7" data-key="number">
        </div>
        <div>
          <label>포지션</label>
          <select data-key="position">
            <option value="">선택</option>
            <option>G</option><option>F</option><option>C</option>
          </select>
        </div>
      </div>
      <div class="row row-2" style="margin-top:8px">
        <div>
          <label>생년월일 (선택)</label>
          <div class="date-field">
            <input type="date" data-key="birth" inputmode="numeric" pattern="\\d{4}-\\d{2}-\\d{2}">
            <button type="button" class="calendar-btn" aria-label="캘린더 열기">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="3" y="4" width="18" height="18" rx="3" stroke="#6b7684"/>
                <path d="M8 2v4M16 2v4" stroke="#6b7684"/>
                <path d="M3 9h18" stroke="#6b7684"/>
              </svg>
            </button>
          </div>
          <div class="muted age-text">만 나이: -</div>
        </div>
        <div>
          <label>선출여부</label>
          <select data-key="elite">
            <option value="">선택</option>
            <option value="선출">선출</option>
            <option value="비선출">비선출</option>
          </select>
        </div>
      </div>
      <div class="player-toolbar">
        <span class="muted">선수 #${idx+1}</span>
        <button class="btn-sm remove">삭제</button>
      </div>
    `;
    div.querySelector('.remove').addEventListener('click',()=>div.remove());
    const dateInput = div.querySelector('input[type="date"][data-key="birth"]');
    const calBtn = div.querySelector('.calendar-btn');
    const ageEl = div.querySelector('.age-text');
    const updateAge = () => {
      const v = dateInput.value; const age = calcAge(v);
      if (ageEl) ageEl.textContent = '만 나이: ' + (age === '' ? '-' : age + '세');
    };
    if (calBtn && dateInput) {
      calBtn.addEventListener('click', () => { if (dateInput.showPicker) dateInput.showPicker(); else { dateInput.focus(); dateInput.click(); } });
      dateInput.addEventListener('input', updateAge);
      updateAge();
    }
    return div;
  }

  const playersDiv = document.getElementById('players');
  const addPlayerBtn = document.getElementById('addPlayerBtn');
  addPlayerBtn.addEventListener('click', ()=>{
    const idx = playersDiv.querySelectorAll('.player-card').length;
    playersDiv.appendChild(createPlayerCard(idx));
  });
  for(let i=0;i<5;i++) addPlayerBtn.click(); // 기본 5명

  function showToast(msg){
    const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2600);
  }

  /* ✅ 제출 핸들러 (중복 제출 방지 + 성공 시 버튼 고정) */
  const submitBtn = document.getElementById('submitBtn');
  let submitting = false;

  submitBtn.addEventListener('click', async ()=>{
    if (submitting) return;          // 중복 클릭 방지
    submitting = true;
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '제출 중...';

    const province = document.getElementById('province').value.trim();
    const city = document.getElementById('city').value.trim();
    const region = province && city ? `${province} ${city}` : '';

    const team = {
      region,
      teamName: document.getElementById('teamName').value.trim(),
      managerName: document.getElementById('managerName').value.trim(),
      managerPhone: document.getElementById('managerPhone').value.trim(),
      category: document.getElementById('category').value,
      division: document.getElementById('division').value,
      uniformHome: document.getElementById('uniformHome')?.value?.trim() || '',
      uniformAway: document.getElementById('uniformAway')?.value?.trim() || '',
    };

    if (!region || !team.teamName || !team.managerName || !team.managerPhone){
      alert('시도/시군구, 팀명, 대표자, 연락처를 모두 입력해 주세요.');
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      submitting = false;
      return;
    }

    const playerCards = Array.from(playersDiv.querySelectorAll('.player-card'));
    const players = playerCards.map(card=>{
      const get = k => card.querySelector(`[data-key="${k}"]`).value.trim();
      return { name:get('name'), number:get('number'), position:get('position'), birth:get('birth'), memo:get('elite') };
    }).filter(p => p.name);

    if (players.length < 5){
      alert('선수는 최소 5명 이상 입력해 주세요.');
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      submitting = false;
      return;
    }

    const numbers = players.map(p=>p.number).filter(Boolean);
    const dup = numbers.find((n,i)=> n && numbers.indexOf(n) !== i);
    if (dup){
      const ok = confirm(`등번호 ${dup}가 중복됩니다. 그대로 제출할까요?`);
      if (!ok){
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        submitting = false;
        return;
      }
    }

    try{
      const res = await fetch(`${WEB_APP_URL}?path=registerTeam`, {
        method:'POST',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' }, // CORS 프리플라이트 회피
        body: JSON.stringify({ team, players })
      });
      const json = await res.json();
      if (json.ok){
        if (typeof showToast === 'function') showToast('신청이 완료되었습니다. 팀ID: ' + json.teamId);
        submitBtn.textContent = '제출 완료';
        submitBtn.classList.add('done');
        // 비활성화 유지 + submitting은 유지(중복 제출 차단)
      } else {
        alert('오류: ' + (json.error||'unknown'));
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        submitting = false;
      }
    }catch(err){
      alert('네트워크 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.\n' + err);
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      submitting = false;
    }
  });
</script>
</body>
</html>
