<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR 참가신청서</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f8fbfd; --card:#fff; --shadow:0 8px 32px #1769ff1a; --radius:18px; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',sans-serif;color:#222}
  .wrap{max-width:720px;margin:28px auto;padding:16px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px;position:relative}
  h1{font-size:20px;margin:0 0 14px}
  .section-title{font-weight:700;margin:18px 0 8px}
  label{display:block;font-weight:600;margin:14px 0 6px}
  input,select{width:100%;padding:14px 12px;border:1px solid #e6ecf5;border-radius:14px;font-size:16px;outline:none}
  input:focus,select:focus{border-color:var(--blue)}
  .row{display:grid;gap:12px}
  @media(min-width:560px){ .row-2{grid-template-columns:1fr 1fr} .row-3{grid-template-columns:1fr 1fr 1fr} }
  .muted{color:#6b7684;font-size:13px;margin-top:6px}
  .btn{margin-top:18px;width:100%;padding:14px;border:none;border-radius:14px;background:var(--blue);color:#fff;font-weight:700;font-size:17px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.done{background:#2ebf6f}
  .btn-sm{padding:8px 12px;border-radius:12px;border:1px solid #dfe6ee;background:#fff;cursor:pointer;margin-top:10px}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{width:28px;height:28px;border-radius:50%;border:1px solid #e3e8ef;cursor:pointer}
  .colorbar{display:flex;gap:10px;align-items:center;margin-top:8px}
  .colorbox{flex:1;display:flex;gap:8px;align-items:center}
  .colorhex{width:120px}
  .player-card{border:1px dashed #e6ecf5;border-radius:14px;padding:12px;margin-top:10px;background:#fafcff}
  .player-toolbar{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#222;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.25s}
  .toast.show{opacity:1}
  .date-field{position:relative;display:flex;align-items:center}
  .date-field input[type="date"]{width:100%;padding:14px 44px 14px 12px;border:1px solid #e6ecf5;border-radius:14px;font-size:16px}
  .calendar-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:1px solid #dfe6ee;background:#fff;border-radius:12px;padding:6px 8px;cursor:pointer}
  .calendar-btn:active{transform:translateY(-50%) scale(0.98)}
  .calendar-btn svg{width:18px;height:18px;display:block}
  /* 로고 */
  .brand{position:absolute;right:30px;top:30px}
  .brand img{height:24px;opacity:.95}

  /* 수정/셀프등록 링크 박스 */
  #editLinkWrap,#joinLinkWrap{display:none;margin-top:10px}
  #editLinkInput,#joinLinkInput{flex:1;padding:10px 12px;border:1px solid #e6ecf5;border-radius:12px;font-size:14px}

  /* 지난 명단 모달 */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .box{max-width:720px;width:100%;background:#fff;border-radius:16px;padding:16px;max-height:80vh;overflow:auto}
  .roster{border:1px solid #eef2f7;border-radius:12px;padding:12px;margin-top:10px}
  .roster h4{margin:0 0 8px;font-size:14px}
  .row-4{display:grid;gap:8px;grid-template-columns:1.2fr .8fr .8fr 1fr}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="brand"><img src="BDR(배경없음).png" alt="BDR"></div>

    <h1>BDR 참가신청서</h1>
    <div class="muted">참가 대회 선택 → 팀 대표 정보 → 선수 명단 → 제출</div>

    <!-- 0) 대회 선택 -->
    <div class="section-title">0) 참가희망 대회</div>
    <div>
      <label>대회 선택</label>
      <select id="tourSelect"><option value="">대회를 선택하세요</option></select>
      <div id="tourInfo" class="badge" style="display:none">
        <span id="tourName" class="pill"></span>
        <span id="tourStatus" class="pill"></span>
        <span id="tourDate" class="pill"></span>
        <a id="tourUrl" class="pill" href="#" target="_blank" rel="noopener" style="text-decoration:none;display:none">안내</a>
      </div>
      <div class="muted">※ 대회 설정에 따라 <b>종별/디비전</b>이 제한됩니다.</div>
    </div>

    <!-- ① 팀 기본정보 -->
    <div class="section-title">① 팀 기본정보</div>
    <div class="row row-2">
      <div>
        <label>시도 선택</label>
        <select id="province">
          <option value="">선택</option>
          <option>서울특별시</option><option>부산광역시</option><option>대구광역시</option>
          <option>인천광역시</option><option>광주광역시</option><option>대전광역시</option>
          <option>울산광역시</option><option>세종특별자치시</option><option>경기도</option>
          <option>강원특별자치도</option><option>충청북도</option><option>충청남도</option>
          <option>전북특별자치도</option><option>전라남도</option><option>경상북도</option>
          <option>경상남도</option><option>제주특별자치도</option>
        </select>
      </div>
      <div>
        <label>시군구 선택</label>
        <select id="city" disabled>
          <option value="">시도를 먼저 선택하세요</option>
        </select>
      </div>
    </div>
    <div class="row row-2">
      <div>
        <label>팀명</label>
        <input id="teamName" placeholder="예: 슬로우" />
      </div>
      <div>
        <label>대표자 이름</label>
        <input id="managerName" placeholder="이름" />
      </div>
    </div>
    <div class="row row-2">
      <div>
        <label>대표자 연락처</label>
        <input id="managerPhone" placeholder="010-0000-0000" inputmode="numeric" autocomplete="tel" />
        <div class="muted"><button class="btn-sm" id="btnPast">지난 명단 불러오기</button></div>
      </div>
    </div>

    <!-- ② 종별/디비전 -->
    <div class="section-title">② 종별/디비전</div>
    <div class="row row-2">
      <div>
        <label>종별</label>
        <select id="category" disabled><option value="">대회를 먼저 선택하세요</option></select>
      </div>
      <div>
        <label>디비전</label>
        <select id="division" disabled><option value="">종별을 먼저 선택하세요</option></select>
      </div>
    </div>

    <!-- ③ 유니폼 색상 -->
    <div class="section-title">③ 유니폼 색상</div>
    <label>홈 색상</label>
    <div class="chips" data-target="uniformHome">
      <div class="chip" style="background:#ffffff" data-color="#ffffff"></div>
      <div class="chip" style="background:#000000" data-color="#000000"></div>
      <div class="chip" style="background:#1769ff" data-color="#1769ff"></div>
      <div class="chip" style="background:#ff3b30" data-color="#ff3b30"></div>
      <div class="chip" style="background:#34c759" data-color="#34c759"></div>
      <div class="chip" style="background:#ffcc00" data-color="#ffcc00"></div>
      <div class="chip" style="background:#8e8e93" data-color="#8e8e93"></div>
    </div>
    <div class="colorbar">
      <div class="colorbox">
        <input type="color" id="uniformHomePicker" />
        <input class="colorhex" id="uniformHome" placeholder="#1769ff" />
      </div>
    </div>

    <label>어웨이 색상</label>
    <div class="chips" data-target="uniformAway">
      <div class="chip" style="background:#ffffff" data-color="#ffffff"></div>
      <div class="chip" style="background:#000000" data-color="#000000"></div>
      <div class="chip" style="background:#1769ff" data-color="#1769ff"></div>
      <div class="chip" style="background:#ff3b30" data-color="#ff3b30"></div>
      <div class="chip" style="background:#34c759" data-color="#34c759"></div>
      <div class="chip" style="background:#ffcc00" data-color="#ffcc00"></div>
      <div class="chip" style="background:#8e8e93" data-color="#8e8e93"></div>
    </div>
    <div class="colorbar">
      <div class="colorbox">
        <input type="color" id="uniformAwayPicker" />
        <input class="colorhex" id="uniformAway" placeholder="#000000" />
      </div>
    </div>

    <!-- ④ 선수 명단 -->
    <div class="section-title">④ 선수 명단</div>
    <div id="players"></div>
    <button class="btn-sm" id="addPlayerBtn">선수 추가 +</button>
    <div class="muted">※ 최소 5명 권장. 팀 내 등번호 중복 없도록 확인해 주세요.</div>

    <!-- 제출 -->
    <button class="btn" id="submitBtn">신청서 제출</button>

    <!-- 수정 링크 -->
    <div id="editLinkWrap">
      <div class="muted" style="margin-bottom:6px;">수정 링크</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="editLinkInput" type="text" readonly>
        <button class="btn-sm" id="copyEditLinkBtn" type="button">복사</button>
      </div>
    </div>

    <!-- 팀원 셀프등록 링크 -->
    <div id="joinLinkWrap">
      <div class="muted" style="margin-bottom:6px;">팀원 셀프등록 링크</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="joinLinkInput" type="text" readonly>
        <button class="btn-sm" id="copyJoinLinkBtn" type="button">복사</button>
      </div>
    </div>

    <div class="toast" id="toast">완료</div>
  </div>
</div>

<!-- 지난 명단 모달 -->
<div class="modal" id="pastModal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">지난 명단 불러오기</h3>
      <button class="btn-sm" id="closePast">&times;</button>
    </div>
    <div class="muted">대표자 연락처 기준 최근 접수한 팀의 명단을 가져올 수 있어요. 가져올 선수를 체크하세요.</div>
    <div id="pastList"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button class="btn" id="applyPast">선택 선수 추가</button>
    </div>
  </div>
</div>

<script>
  /* ====== 설정 ====== */
  const WEB_APP_URL = 'YOUR_DEPLOYED_WEB_APP_URL_HERE'; // ← 실제 배포 URL로 교체!
  const qs = new URLSearchParams(location.search);
  const editTeamId = qs.get('edit');
  const editCode   = qs.get('code');

  /* ====== 유틸 ====== */
  function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2200); }
  function formatPhoneNumber(value) {
    value = value.replace(/[^0-9]/g, '');
    if (value.length < 4) return value;
    if (value.length < 8) return value.replace(/(\d{3})(\d+)/, '$1-$2');
    return value.replace(/(\d{3})(\d{4})(\d+)/, '$1-$2-$3');
  }
  const phoneInput = document.getElementById('managerPhone');
  phoneInput.addEventListener('input', function () {
    const caret = this.selectionStart, before = this.value;
    this.value = formatPhoneNumber(this.value);
    const diff = this.value.length - before.length;
    this.selectionEnd = Math.max(0, (caret || 0) + diff);
  });

  /* ====== 대회 데이터 ====== */
  let TOUR_MAP = {}; let currentTour = null;
  async function loadTournaments() {
    try {
      const res = await fetch(`${WEB_APP_URL}?path=tournaments`);
      const json = await res.json(); if (!json.ok) return;
      const sel = document.getElementById('tourSelect');
      sel.innerHTML = '<option value="">대회를 선택하세요</option>';
      (json.rows||[]).forEach(t=>{
        TOUR_MAP[t.TourID] = t;
        const o=document.createElement('option'); o.value=t.TourID; o.textContent = t.name; sel.appendChild(o);
      });
    } catch(e){}
  }
  function formatDateK(v){ try{ const d=new Date(v); if(isNaN(d)) return v||''; return `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;}catch{return v||'';} }
  function renderTourInfo(t){
    const box=document.getElementById('tourInfo');
    if (!t) { box.style.display='none'; return; }
    document.getElementById('tourName').textContent = t.name||'';
    document.getElementById('tourStatus').textContent = t.status||'상태미정';
    document.getElementById('tourDate').textContent = (t.start||t.end)? `${formatDateK(t.start)} ~ ${formatDateK(t.end)}` : '일정미정';
    const a=document.getElementById('tourUrl'); if (t.url){ a.href=t.url; a.style.display='inline-block'; } else { a.style.display='none'; }
    box.style.display='inline-flex';
  }
  const categorySelect=document.getElementById('category');
  const divisionSelect=document.getElementById('division');
  function fillCategoriesFromTour(t){
    categorySelect.innerHTML=''; divisionSelect.innerHTML='<option value="">종별을 먼저 선택하세요</option>'; divisionSelect.disabled=true;
    if (!t || !t.divs || Object.keys(t.divs).length===0){ categorySelect.disabled=true; categorySelect.innerHTML='<option value="">대회에 종별/디비전 설정이 없습니다</option>'; return; }
    categorySelect.disabled=false;
    const o0=document.createElement('option'); o0.value=''; o0.textContent='선택'; categorySelect.appendChild(o0);
    Object.keys(t.divs).forEach(cat=>{ const o=document.createElement('option'); o.value=cat; o.textContent=cat; categorySelect.appendChild(o); });
  }
  function fillDivisions(cat){
    divisionSelect.innerHTML='';
    if (!currentTour || !cat){ divisionSelect.disabled=true; divisionSelect.innerHTML='<option value="">종별을 먼저 선택하세요</option>'; return; }
    const arr=currentTour.divs[cat]||[];
    if (!arr.length){ divisionSelect.disabled=true; divisionSelect.innerHTML='<option value="">해당 종별의 디비전 없음</option>'; return; }
    divisionSelect.disabled=false;
    const o0=document.createElement('option'); o0.value=''; o0.textContent='선택'; divisionSelect.appendChild(o0);
    arr.forEach(dv=>{ const o=document.createElement('option'); o.value=dv; o.textContent=dv; divisionSelect.appendChild(o); });
  }
  document.getElementById('tourSelect').addEventListener('change', e=>{
    const id=e.target.value; currentTour=id?TOUR_MAP[id]:null; renderTourInfo(currentTour); fillCategoriesFromTour(currentTour);
  });
  categorySelect.addEventListener('change', e=>fillDivisions(e.target.value));

  /* ====== 시도 → 시군구 ====== */
  const regionData = {/* (생략: 기존 시/군/구 맵 그대로) */};
  // — 실제 배포 시, 기존에 쓰던 regionData 객체를 그대로 붙여넣으세요 —
  const provinceSel=document.getElementById('province'); const citySel=document.getElementById('city');
  provinceSel.addEventListener('change', e => {
    const prov=e.target.value; citySel.innerHTML=''; if (!prov){ citySel.disabled=true; citySel.innerHTML='<option value="">시도를 먼저 선택하세요</option>'; return; }
    const list=regionData[prov]||[]; citySel.disabled=false; const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='선택'; citySel.appendChild(opt0);
    list.forEach(city=>{ const o=document.createElement('option'); o.value=city; o.textContent=city; citySel.appendChild(o); });
  });

  /* ====== 유니폼 컬러 동기화 ====== */
  document.querySelectorAll('.chips').forEach(row=>{
    const target=row.getAttribute('data-target');
    row.addEventListener('click', e=>{ const chip=e.target.closest('.chip'); if(!chip) return; const color=chip.getAttribute('data-color'); document.getElementById(target).value=color; const picker=document.getElementById(target+'Picker'); if(picker) picker.value=color; });
  });
  function bindColorSync(pickerId, hexId){
    const picker=document.getElementById(pickerId), hex=document.getElementById(hexId);
    picker.addEventListener('input', ()=> hex.value=picker.value);
    hex.addEventListener('input', ()=>{ const v=hex.value; if (/^#?[0-9A-Fa-f]{6}$/.test(v.replace('#',''))){ picker.value=v.startsWith('#')?v:'#'+v; hex.value=picker.value; }});
  }
  bindColorSync('uniformHomePicker','uniformHome'); bindColorSync('uniformAwayPicker','uniformAway');

  /* ====== 선수 카드 ====== */
  function calcAge(yyyyMMdd){ if(!yyyyMMdd) return ''; const d=new Date(yyyyMMdd); if(Number.isNaN(d.getTime())) return ''; const today=new Date(); let age=today.getFullYear()-d.getFullYear(); const m=today.getMonth()-d.getMonth(); if(m<0||(m===0&&today.getDate()<d.getDate())) age--; return age; }
  function createPlayerCard(idx){
    const div=document.createElement('div'); div.className='player-card';
    div.innerHTML=`
      <div class="row row-3">
        <div><label>선수 이름</label><input placeholder="이름" data-key="name"></div>
        <div><label>등번호</label><input placeholder="예: 7" data-key="number"></div>
        <div><label>포지션</label>
          <select data-key="position"><option value="">선택</option><option>G</option><option>F</option><option>C</option></select>
        </div>
      </div>
      <div class="row row-2" style="margin-top:8px">
        <div>
          <label>생년월일 (선택)</label>
          <div class="date-field">
            <input type="date" data-key="birth" inputmode="numeric" pattern="\\d{4}-\\d{2}-\\d{2}">
            <button type="button" class="calendar-btn" aria-label="캘린더 열기">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="3" y="4" width="18" height="18" rx="3" stroke="#6b7684"/>
                <path d="M8 2v4M16 2v4" stroke="#6b7684"/>
                <path d="M3 9h18" stroke="#6b7684"/>
              </svg>
            </button>
          </div>
          <div class="muted age-text">만 나이: -</div>
        </div>
        <div>
          <label>선출여부</label>
          <select data-key="elite"><option value="">선택</option><option value="선출">선출</option><option value="비선출">비선출</option></select>
        </div>
      </div>
      <div class="player-toolbar">
        <span class="muted">선수 #${idx+1}</span>
        <button class="btn-sm remove">삭제</button>
      </div>`;
    div.querySelector('.remove').addEventListener('click',()=>div.remove());
    const dateInput=div.querySelector('input[data-key="birth"]');
    const calBtn=div.querySelector('.calendar-btn'); const ageEl=div.querySelector('.age-text');
    const updateAge=()=>{ const v=dateInput.value; const a=calcAge(v); ageEl.textContent='만 나이: '+(a===''?'-':a+'세'); };
    if (calBtn && dateInput){ calBtn.addEventListener('click', ()=>{ if(dateInput.showPicker) dateInput.showPicker(); else {dateInput.focus(); dateInput.click();} }); dateInput.addEventListener('input', updateAge); updateAge(); }
    return div;
  }
  const playersDiv=document.getElementById('players'); const addPlayerBtn=document.getElementById('addPlayerBtn');
  addPlayerBtn.addEventListener('click', ()=>{ const idx=playersDiv.querySelectorAll('.player-card').length; playersDiv.appendChild(createPlayerCard(idx)); });
  for(let i=0;i<5;i++) addPlayerBtn.click();

  /* ====== 지난 명단 불러오기 ====== */
  const pastModal=document.getElementById('pastModal'); const pastList=document.getElementById('pastList');
  document.getElementById('btnPast').addEventListener('click', async ()=>{
    const phone=(document.getElementById('managerPhone').value||'').trim(); if(!phone) return alert('먼저 대표자 연락처를 입력하세요.');
    try{
      const r=await fetch(`${WEB_APP_URL}?path=pastRosters&phone=${encodeURIComponent(phone)}&limit=3`); const j=await r.json();
      if(!j.ok) return alert('불러오기 실패: ' + (j.error||'unknown'));
      renderPast(j.rosters||[]);
      pastModal.style.display='flex';
    }catch(e){ alert('불러오기 오류: '+e.message); }
  });
  document.getElementById('closePast').addEventListener('click', ()=> pastModal.style.display='none');
  function renderPast(bundles){
    pastList.innerHTML='';
    if (!bundles.length){ pastList.innerHTML='<div class="muted">과거 접수 내역이 없습니다.</div>'; return; }
    bundles.forEach(b=>{
      const box=document.createElement('div'); box.className='roster';
      box.innerHTML=`<h4>${b.teamName||''} <span class="muted">(${b.tourName||''})</span> · <span class="muted">${new Date(b.createdAt).toLocaleString()}</span></h4>`;
      const table=document.createElement('div');
      (b.players||[]).forEach(pl=>{
        const row=document.createElement('div'); row.className='row-4';
        row.innerHTML=`
          <label style="display:flex;align-items:center;gap:8px;margin:0">
            <input type="checkbox" data-bundle="${b.teamId}" data-name="${pl.name||''}" data-number="${pl.number||''}" data-position="${pl.position||''}" data-birth="${pl.birth||''}" data-elite="${pl.elite||''}">
            <span>${pl.name||''}</span>
          </label>
          <div class="muted">등번호: ${pl.number||''}</div>
          <div class="muted">포지션: ${pl.position||''}</div>
          <div class="muted">생년월일: ${pl.birth||''}</div>`;
        table.appendChild(row);
      });
      box.appendChild(table); pastList.appendChild(box);
    });
  }
  document.getElementById('applyPast').addEventListener('click', ()=>{
    const checks=[...pastList.querySelectorAll('input[type="checkbox"]:checked')];
    if (!checks.length) { showToast('선택된 선수가 없어요'); return; }
    checks.forEach(ch=>{
      const card=createPlayerCard(playersDiv.querySelectorAll('.player-card').length);
      card.querySelector('[data-key="name"]').value = ch.dataset.name || '';
      card.querySelector('[data-key="number"]').value = ch.dataset.number || '';
      card.querySelector('[data-key="position"]').value = ch.dataset.position || '';
      const birth = card.querySelector('[data-key="birth"]'); birth.value = ch.dataset.birth || ''; birth.dispatchEvent(new Event('input'));
      card.querySelector('[data-key="elite"]').value = ch.dataset.elite || '';
      playersDiv.appendChild(card);
    });
    pastModal.style.display='none';
    showToast('선택한 선수를 추가했어요');
  });

  /* ====== 수정 모드 프리로드 ====== */
  async function preloadForEdit() {
    if (!editTeamId || !editCode) return;
    try {
      const res = await fetch(`${WEB_APP_URL}?path=getTeam&teamId=${encodeURIComponent(editTeamId)}&code=${encodeURIComponent(editCode)}`);
      const json = await res.json();
      if (!json.ok) { alert('수정 링크가 유효하지 않습니다.'); return; }

      // 대회 먼저
      if (json.team.tourId) {
        await loadTournaments();
        document.getElementById('tourSelect').value = json.team.tourId;
        currentTour = TOUR_MAP[json.team.tourId];
        renderTourInfo(currentTour);
        fillCategoriesFromTour(currentTour);
        document.getElementById('category').value = json.team.category || '';
        fillDivisions(json.team.category || '');
        setTimeout(()=>{ document.getElementById('division').value = json.team.division || ''; }, 0);
      } else {
        await loadTournaments();
      }

      // 팀 채우기
      document.getElementById('province').value = json.team.province || '';
      document.getElementById('province').dispatchEvent(new Event('change'));
      setTimeout(()=>{ document.getElementById('city').value = json.team.city || ''; }, 0);
      document.getElementById('teamName').value = json.team.teamName || '';
      document.getElementById('managerName').value = json.team.managerName || '';
      document.getElementById('managerPhone').value = formatPhoneNumber(json.team.managerPhone || '');
      document.getElementById('uniformHome').value = json.team.uniformHome || '';
      document.getElementById('uniformAway').value = json.team.uniformAway || '';
      const uh = document.getElementById('uniformHomePicker'), ua = document.getElementById('uniformAwayPicker');
      if (uh) uh.value = json.team.uniformHome || '#000000';
      if (ua) ua.value = json.team.uniformAway || '#ffffff';

      // 선수
      playersDiv.innerHTML = '';
      (json.players || []).forEach((pl, idx)=>{
        const card = createPlayerCard(idx);
        card.querySelector('[data-key="name"]').value = pl.name || '';
        card.querySelector('[data-key="number"]').value = pl.number || '';
        card.querySelector('[data-key="position"]').value = pl.position || '';
        const birth = card.querySelector('[data-key="birth"]'); birth.value = pl.birth || ''; birth.dispatchEvent(new Event('input'));
        card.querySelector('[data-key="elite"]').value = pl.elite || '';
        playersDiv.appendChild(card);
      });

      document.getElementById('submitBtn').textContent = '수정 저장';

      // joinUrl/수정링크 표시 (서버가 joinUrl 제공)
      if (json.joinUrl) revealJoinLink(json.joinUrl);
      const editUrl = `${location.origin}${location.pathname}?edit=${encodeURIComponent(editTeamId)}&code=${encodeURIComponent(editCode)}`;
      revealEditLink(editUrl);
    } catch(e) { console.error(e); }
  }

  /* ====== 링크 표시/복사 ====== */
  function revealEditLink(url){ const wrap=document.getElementById('editLinkWrap'); const input=document.getElementById('editLinkInput'); input.value=url; wrap.style.display='block'; }
  function revealJoinLink(url){ const wrap=document.getElementById('joinLinkWrap'); const input=document.getElementById('joinLinkInput'); input.value=url; wrap.style.display='block'; }
  (function(){
    const b1=document.getElementById('copyEditLinkBtn'); if (b1) b1.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(document.getElementById('editLinkInput').value); showToast('복사되었습니다'); }catch{ const i=document.getElementById('editLinkInput'); i.select(); document.execCommand('copy'); showToast('복사되었습니다'); } });
    const b2=document.getElementById('copyJoinLinkBtn'); if (b2) b2.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(document.getElementById('joinLinkInput').value); showToast('복사되었습니다'); }catch{ const i=document.getElementById('joinLinkInput'); i.select(); document.execCommand('copy'); showToast('복사되었습니다'); } });
  })();

  /* ====== 제출 핸들러 ====== */
  const submitBtn=document.getElementById('submitBtn'); let submitting=false;
  submitBtn.addEventListener('click', async ()=>{
    if (submitting) return; submitting=true; const original=submitBtn.textContent; submitBtn.disabled=true; submitBtn.textContent='제출 중...';

    const province=document.getElementById('province').value.trim();
    const city=document.getElementById('city').value.trim();
    const region=province && city ? `${province} ${city}` : '';

    const team = {
      tourId: (document.getElementById('tourSelect').value || '').trim(),
      tourName: currentTour?.name || '',
      region,
      teamName: document.getElementById('teamName').value.trim(),
      managerName: document.getElementById('managerName').value.trim(),
      managerPhone: document.getElementById('managerPhone').value.trim(),
      category: document.getElementById('category').value,
      division: document.getElementById('division').value,
      uniformHome: document.getElementById('uniformHome')?.value?.trim() || '',
      uniformAway: document.getElementById('uniformAway')?.value?.trim() || '',
    };
    if (!team.tourId){ alert('참가할 대회를 선택해 주세요.'); return reset(); }
    if (!region || !team.teamName || !team.managerName || !team.managerPhone){ alert('시도/시군구, 팀명, 대표자, 연락처를 모두 입력해 주세요.'); return reset(); }
    if (!team.category || !team.division){ alert('종별과 디비전을 선택해 주세요.'); return reset(); }

    const playerCards=[...playersDiv.querySelectorAll('.player-card')];
    const players=playerCards.map(card=>{
      const get=k=>(card.querySelector(`[data-key="${k}"]`)?.value||'').trim();
      return { name:get('name'), number:get('number'), position:get('position'), birth:get('birth'), memo:get('elite') };
    }).filter(p=>p.name);
    if (players.length < 5){ alert('선수는 최소 5명 이상 입력해 주세요.'); return reset(); }
    const numbers=players.map(p=>p.number).filter(Boolean); const dup=numbers.find((n,i)=>n && numbers.indexOf(n)!==i);
    if (dup){ if(!confirm(`등번호 ${dup}가 중복됩니다. 그대로 제출할까요?`)) return reset(); }

    function reset(){ submitBtn.disabled=false; submitBtn.textContent=original; submitting=false; }

    try{
      const payload={ team, players, base: location.origin + location.pathname };
      let url = `${WEB_APP_URL}?path=registerTeam`;
      if (editTeamId && editCode){ url = `${WEB_APP_URL}?path=updateTeam`; payload.teamId=editTeamId; payload.editCode=editCode; }

      const res=await fetch(url,{ method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload) });
      const json=await res.json();
      if (json.ok){
        if (editTeamId){ showToast('수정 저장 완료'); submitBtn.textContent='수정 완료'; if (json.editUrl) revealEditLink(json.editUrl); if (json.joinUrl) revealJoinLink(json.joinUrl); }
        else { showToast('신청 완료!'); submitBtn.textContent='제출 완료'; const eurl = json.editUrl || `${location.origin}${location.pathname}?edit=${encodeURIComponent(json.teamId)}&code=${encodeURIComponent(json.editCode)}`; revealEditLink(eurl); if (json.joinUrl) revealJoinLink(json.joinUrl); }
        submitBtn.classList.add('done');
      } else { alert('오류: ' + (json.error||'unknown')); reset(); }
    }catch(err){ alert('네트워크 오류: '+err.message); reset(); }
  });

  /* ====== 부트 ====== */
  (async function boot(){ await loadTournaments(); await preloadForEdit(); })();
</script>
</body>
</html>
