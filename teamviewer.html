<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BDR TeamViewer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{ --blue:#1769ff; --bg:#f6f8fb; --card:#fff; --ink:#1f2937; --muted:#6b7280; --green:#16a34a; --red:#ef4444; --shadow:0 10px 30px #1769ff22; --radius:18px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);font-family:'Pretendard','Apple SD Gothic Neo',system-ui,-apple-system,sans-serif;color:var(--ink)}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px 56px}
  header{position:sticky;top:0;z-index:100;background:linear-gradient(180deg,#f6f8fb 0%,#f6f8fbdd 70%,#f6f8fb00 100%);backdrop-filter:saturate(1.2) blur(8px)}
  .head{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 4px}
  h1{font-size:20px;margin:0 8px 0 0;font-weight:700;letter-spacing:0.2px}
  .badge{font-size:12px;padding:4px 8px;background:#e9efff;border-radius:999px;color:#2b53c4;font-weight:600}
  .panel{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0 10px}
  @media (max-width:760px){ .panel{grid-template-columns:1fr} }
  .select,.input{display:flex;align-items:center;gap:8px;padding:12px 14px;background:var(--card);border-radius:14px;box-shadow:var(--shadow)}
  .select label,.input label{font-size:12px;color:var(--muted);white-space:nowrap}
  select,input[type="text"]{all:unset;font-size:14px;flex:1}
  select{cursor:pointer}
  .btns{display:flex;flex-wrap:wrap;gap:8px}
  .btn{border:1px solid #e5e7eb;background:#fff;padding:10px 12px;border-radius:12px;cursor:pointer;font-size:13px}
  .btn.primary{background:#1f5eff;color:#fff;border-color:#1f5eff}
  .card{background:var(--card);border-radius:24px;box-shadow:var(--shadow);padding:18px;margin-top:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:6px 10px;font-size:12px;color:#374151}
  .chip.green{background:#ecfdf5;border-color:#bbf7d0;color:#166534}
  .chip.blue{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
  .right{margin-left:auto}
  .tablewrap{overflow:auto;border:1px solid #e5e7eb;border-radius:16px;margin-top:12px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  thead th{position:sticky;top:0;background:#f9fafb;border-bottom:1px solid #e5e7eb;padding:10px 8px;text-align:left;white-space:nowrap;font-weight:700}
  tbody td{border-bottom:1px solid #f3f4f6;padding:10px 8px;white-space:nowrap}
  tbody tr:hover{background:#fafafa}
  .muted{color:var(--muted)}
  .helper{font-size:12px;color:var(--muted);margin-top:6px}
  @keyframes sh{0%{background-position:-100px 0}100%{background-position:100px 0}}
  .skeleton{height:12px;background:linear-gradient(90deg,#f3f4f6 0%,#eef0f3 40%,#f3f4f6 80%);border-radius:6px;animation:sh 1.4s infinite}
  @media print{ header,.panel,.btns,.helper{display:none!important} .card{box-shadow:none;border:none;padding:0;margin:0} .wrap{max-width:100%;padding:0} body{background:#fff}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="head">
      <div class="row"><h1>TeamViewer</h1><span class="badge">mobile-first</span></div>
      <div class="btns"><button class="btn ghost" id="shareBtn">공유링크</button><button class="btn ghost" id="csvBtn">CSV 다운로드</button><button class="btn ghost" id="printBtn">인쇄</button></div>
    </div>
    <div class="panel">
      <div class="select"><label>대회</label><select id="tourSelect"></select></div>
      <div class="select"><label>팀</label><select id="teamSelect"></select></div>
      <div class="input"><label>팀 검색</label><input id="teamSearch" type="text" placeholder="팀 이름 일부로 검색" /></div>
      <div class="row" style="align-items:center">
        <label class="chip"><input type="checkbox" id="hidePhone" style="margin-right:6px" checked>전화번호 숨김</label>
        <span class="helper">개인정보 보호를 위해 기본값은 숨김입니다.</span>
      </div>
    </div>
  </header>

  <section class="card" id="metaCard" style="display:none">
    <div class="row">
      <div class="chip blue" id="divChip" style="display:none"></div>
      <div class="chip" id="divSetChip" style="display:none"></div>
      <span class="right muted" id="updatedAt"></span>
    </div>
  </section>

  <section class="card" id="tableCard" style="display:none">
    <div class="tablewrap">
      <table id="rosterTable">
        <thead><tr id="theadRow"></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="helper" id="countText"></div>
  </section>

  <section class="card" id="emptyCard"><div class="skeleton" style="width:260px"></div><p class="muted">선수 명단이 없거나 아직 불러오지 못했어요.</p></section>
</div>

<script>
(() => {
  /* ★★★ 반드시 TeamViewer 전용 웹앱 URL로 바꾸세요 ★★★
     (예) https://script.google.com/macros/s/AKfycb.../exec */
  const API_BASE = 'https://script.google.com/macros/s/PASTE_TEAMVIEWER_DEPLOY_ID/exec';

  const els = {
    tourSelect: document.getElementById('tourSelect'),
    teamSelect: document.getElementById('teamSelect'),
    teamSearch: document.getElementById('teamSearch'),
    hidePhone : document.getElementById('hidePhone'),
    metaCard  : document.getElementById('metaCard'),
    tableCard : document.getElementById('tableCard'),
    emptyCard : document.getElementById('emptyCard'),
    theadRow  : document.getElementById('theadRow'),
    tbody     : document.getElementById('tbody'),
    updatedAt : document.getElementById('updatedAt'),
    countText : document.getElementById('countText'),
  };

  const qs = (obj={}) => new URLSearchParams(obj).toString();
  const cache = {
    get:k=>{try{const v=sessionStorage.getItem(k);if(!v)return null;const o=JSON.parse(v);if(Date.now()>o.exp)return null;return o.val;}catch{return null}},
    set:(k,val,sec=300)=>{try{sessionStorage.setItem(k,JSON.stringify({exp:Date.now()+sec*1000,val}))}catch{}}
  };
  async function GET(path, params={}, {ttl=300}={}){
    const url = `${API_BASE}?${qs({path, ...params, t:Date.now()})}`;
    const key = `tv:${path}:${JSON.stringify(params)}`;
    const c = cache.get(key); if(c) return c;
    const r = await fetch(url);
    const t = await r.text();
    let j; try{ j=JSON.parse(t);}catch(e){ throw new Error('JSON 파싱 실패'); }
    if(j.ok===false){
      if(/unknown path/i.test(j.error||'')){
        alert('TeamViewer 전용 웹앱 URL이 아닙니다.\n관리자 백엔드 URL이 아닌 TeamViewer.gs 배포 URL을 teamviewer.html의 API_BASE에 넣어주세요.\n\n테스트: '+API_BASE+'?path=health 를 브라우저에서 열었을 때 "BDR-TeamViewer" 버전 문자열이 보여야 합니다.');
      }
      throw new Error((j.error||'오류'));
    }
    cache.set(key, j, ttl);
    return j;
  }

  async function init(){
    // 연결 사전 점검
    try{
      const h = await GET('health', {}, {ttl:15});
      if(!(h.version||'').includes('BDR-TeamViewer')) {
        alert('연결된 웹앱이 TeamViewer 전용이 아닙니다.\nAPI_BASE를 TeamViewer.gs 배포 URL로 교체하세요.');
      }
    }catch(e){
      // health 실패해도 아래 흐름에서 한번 더 안내됨
    }

    const data = await GET('teamviewer.init', {});
    buildTourSelect(data.tournaments);

    bindEvents();
  }

  function buildTourSelect(tournaments){
    els.tourSelect.innerHTML = '';
    (tournaments||[]).slice().sort((a,b)=> (a.start||'').localeCompare(b.start||'')).reverse()
      .forEach(t=>{
        const opt = document.createElement('option');
        opt.value = t.tourId;
        opt.textContent = (t.name||t.tourId) + (t.start?` (${t.start.slice(5)})`:``);
        els.tourSelect.appendChild(opt);
      });
  }

  function buildTeamSelect(teams){
    els.teamSelect.innerHTML='';
    (teams||[]).forEach(t=>{
      const opt=document.createElement('option');
      opt.value = t.teamId;
      let name = t.displayName||t.teamNameKo||t.teamNameEn||t.teamId;
      if(t.division) name += ` · ${t.division}`;
      opt.textContent = name;
      els.teamSelect.appendChild(opt);
    });
  }

  function bindEvents(){
    els.tourSelect.addEventListener('change', ()=>{
      const tid = els.tourSelect.value;
      const all = window.__INIT?.teamsByTour || {};
      buildTeamSelect(all[tid]||[]);
    });
    document.getElementById('csvBtn').addEventListener('click', ()=>alert('팀을 먼저 선택하세요.'));
    document.getElementById('shareBtn').addEventListener('click', ()=>{ try{navigator.clipboard.writeText(location.href); alert('링크 복사됨');}catch{prompt('링크',location.href)} });
    document.getElementById('printBtn').addEventListener('click', ()=>window.print());
  }

  // 부팅
  init().then(j=>{}).catch(e=>{
    console.error(e);
    alert('초기 데이터 불러오기 실패: ' + (e.message||e));
  });
})();
</script>
</body>
</html>
